#!/usr/bin/env bash
set -e

TITLE="ApacheNest"
AUTHORS="JianZCar and aceday"

INSTALL_DIR="$HOME/Documents/.apachenest"
WWW_DIR="$INSTALL_DIR/www"
CONF_DIR="$INSTALL_DIR/conf"

GREEN="\033[0;32m"
BLUE="\033[0;34m"
YELLOW="\033[1;33m"
RED="\033[0;31m"
NC="\033[0m"

# Default MySQL password
MYSQL_DEFAULT_PASSWORD="root"
CHECK="‚úîÔ∏è"
ERROR="‚ùå"
ROCKET="üöÄ"
GEAR="‚öôÔ∏è"
DOWNLOAD="üì•"
HOURGLASS="‚è≥"
SUCCESS="üéâ"

# Loading spinner function
spinner() {
	local pid=$!
	local delay=0.10
	local spinstr='‚†º‚†π‚†õ‚†è‚†ß‚†∂'
	while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
		local char="${spinstr:0:1}"
		spinstr="${spinstr:1}${char}"
		printf " %s " "$char"
		sleep $delay
		printf "\r"
	done
	printf "\r"
}

configure_env() {
	export NP_LOCATION="$INSTALL_DIR"
	export PATH="$PATH:$INSTALL_DIR/bin"
	export NP_GIT="$(which git)"
	if [[ -f $CONF_DIR/php-version.conf ]]; then
		PHP_VERSION=$(<$CONF_DIR/php-version.conf)
	fi
}

remove_dblock() {
	if [[ -d $INSTALL_DIR/.nix-portable/nix/var/nix/db/db.sqlite.lock ]]; then
		echo -e "\n${YELLOW}DB Lock Found Removing...${NC}"
		rm -rf $INSTALL_DIR/.nix-portable/nix/var/nix/db/db.sqlite.lock
		echo -e "${CHECK} ${GREEN}DB Lock removed${NC}"
	fi
}

setup_nix_portable() {
	echo -e "\n${BLUE}${ROCKET} Installing Nix-Portable ${ROCKET}${NC}"
	echo -e "${GEAR} ${YELLOW}Creating directory structure...${NC}"
	mkdir -p "$INSTALL_DIR/bin"
	mkdir -p "$WWW_DIR"
	mkdir -p "$CONF_DIR"
	mkdir -p "$INSTALL_DIR/apache"
	mkdir -p "$INSTALL_DIR/apache/logs"
	echo -e "${CHECK} ${GREEN}Directories created!${NC}"

	echo -e "\n${DOWNLOAD} ${YELLOW}Downloading nix-portable...${NC}"
	curl -sL https://github.com/DavHau/nix-portable/releases/latest/download/nix-portable-$(uname -m) > $INSTALL_DIR/bin/nix-portable & spinner
	chmod +x "$INSTALL_DIR/bin/nix-portable"
	echo -e "${CHECK} ${GREEN}Download complete!${NC}"
	echo -e "${SUCCESS} ${GREEN}Installation complete!${NC}"
}

install_apache() {
	if ! nix-portable nix path-info -f '<nixpkgs>' apacheHttpd.out >/dev/null 2>&1; then
		echo -e "${DOWNLOAD} ${YELLOW}Downloading Apache...${NC}"
		nix-portable nix-shell -p apacheHttpd --run "" 2>/dev/null & spinner
		echo -e "${CHECK} ${GREEN}Download complete!${NC}"
	fi
}

install_php() {
	if ! nix-portable nix path-info -f '<nixpkgs>' "$PHP_VERSION" >/dev/null 2>&1; then
		echo -e "${DOWNLOAD} ${YELLOW}Downloading $PHP_VERSION...${NC}"
		nix-portable nix-shell -p "$PHP_VERSION" --run "" 2>/dev/null & spinner
		echo -e "${CHECK} ${GREEN}Download complete!${NC}"

		echo "<?php phpinfo(); ?>" > "$WWW_DIR/index.php"
	fi
}

install_mysql() {
	if ! nix-portable nix path-info -f '<nixpkgs>' mysql.out >/dev/null 2>&1; then
		echo -e "${DOWNLOAD} ${YELLOW}Downloading MySQL...${NC}"
		nix-portable nix-shell -p mysql --run "" 2>/dev/null & spinner
		echo -e "${CHECK} ${GREEN}Download complete!${NC}"
	fi
}

install_mailhog() {
	if ! nix-portable nix path-info -f '<nixpkgs>' mailhog >/dev/null 2>&1; then
		echo -e "${DOWNLOAD} ${YELLOW}Downloading MailHog...${NC}"
		nix-portable nix-shell -p mailhog --run "" 2>/dev/null & spinner
		echo -e "${CHECK} ${GREEN}Download complete!${NC}"
	fi
}

config_mailhog() {
	echo -e "${YELLOW}Setting up MailHog...${NC}"
	
	# Create MailHog directory
	if [[ ! -d $INSTALL_DIR/mailhog ]]; then
		mkdir -p "$INSTALL_DIR/mailhog"
		echo -e "${CHECK} ${GREEN}MailHog directory created!${NC}"
	fi
	
	# Create MailHog log file
	if [[ ! -f $INSTALL_DIR/mailhog/mailhog.log ]]; then
		touch "$INSTALL_DIR/mailhog/mailhog.log"
		echo -e "${CHECK} ${GREEN}MailHog log file created!${NC}"
	fi
	
	echo -e "${SUCCESS} ${GREEN}MailHog configuration complete!${NC}"
	echo -e "${BLUE}SMTP Server: localhost:1025${NC}"
	echo -e "${BLUE}Web UI: http://localhost:8025${NC}"
}

setup_mailhog() {
	echo -e "${YELLOW}Installing MailHog ${NC}"
	install_mailhog
	config_mailhog
}

start_mailhog() {
	config_mailhog
	
	if pgrep -af "MailHog" > /dev/null; then
		echo -e "${YELLOW}MailHog is already running!${NC}"
		return 0
	fi
	
	echo -e "${YELLOW}Starting MailHog...${NC}"
	nix-portable nix-shell -p mailhog --run "
		MailHog > $INSTALL_DIR/mailhog/mailhog.log 2>&1 &
	"
	sleep 1
	echo -e "${CHECK} ${GREEN}MailHog started!${NC}"
	echo -e "${BLUE}SMTP Server: localhost:1025${NC}"
	echo -e "${BLUE}Web UI: http://localhost:8025${NC}"
	clear
}

stop_mailhog() {
	echo -e "${YELLOW}Stopping MailHog...${NC}"
	
	if pgrep -af "MailHog" > /dev/null; then
		pkill -f "MailHog" 2>/dev/null || true
		sleep 1
	fi
	
	echo -e "${CHECK} ${GREEN}MailHog stopped!${NC}"
	clear
}

restart_mailhog() {
	stop_mailhog
	sleep 1
	start_mailhog
}

config_php_mail() {
	echo -e "${YELLOW}Configuring PHP to use MailHog...${NC}"
	
	# Create php.ini override for mail settings
	cat > "$CONF_DIR/php-mail.ini" <<EOF
[mail function]
sendmail_path = "/usr/bin/env catchmail -smtp-addr localhost:1025"
SMTP = localhost
smtp_port = 1025
EOF
	
	echo -e "${CHECK} ${GREEN}PHP mail configuration created!${NC}"
	echo -e "${YELLOW}Note: Restart PHP-FPM for changes to take effect.${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

open_mailhog_ui() {
	if ! pgrep -af "MailHog" > /dev/null; then
		echo -e "${ERROR} ${RED}MailHog is not running! Please start MailHog first.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	
	echo -e "${BLUE}Opening MailHog Web UI...${NC}"
	echo -e "${GREEN}URL: http://localhost:8025${NC}"
	
	# Try to open in browser
	if command -v xdg-open &> /dev/null; then
		xdg-open "http://localhost:8025" 2>/dev/null &
	elif command -v open &> /dev/null; then
		open "http://localhost:8025" 2>/dev/null &
	else
		echo -e "${YELLOW}Please open http://localhost:8025 in your browser.${NC}"
	fi
	read -n 1 -s -p "Press any key to continue..."
}

test_email() {
	if ! pgrep -af "MailHog" > /dev/null; then
		echo -e "${ERROR} ${RED}MailHog is not running! Please start MailHog first.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	
	echo -e "${YELLOW}Sending test email...${NC}"
	
	# Create a simple test email using sendmail format
	echo -e "Subject: Test Email from ApacheNest\nFrom: test@apachenest.local\nTo: user@example.com\n\nThis is a test email from ApacheNest MailHog.\nIf you see this in MailHog UI, email is working!" | \
	nix-portable nix-shell -p mailhog --run "MailHog sendmail" 2>/dev/null || \
	(
		# Alternative: use nc/netcat to send directly to SMTP
		{
			echo "EHLO localhost"
			sleep 0.2
			echo "MAIL FROM:<test@apachenest.local>"
			sleep 0.2
			echo "RCPT TO:<user@example.com>"
			sleep 0.2
			echo "DATA"
			sleep 0.2
			echo "Subject: Test Email from ApacheNest"
			echo "From: test@apachenest.local"
			echo "To: user@example.com"
			echo ""
			echo "This is a test email from ApacheNest MailHog."
			echo "If you see this in MailHog UI, email is working!"
			echo "."
			sleep 0.2
			echo "QUIT"
		} | nc localhost 1025 2>/dev/null
	)
	
	echo -e "${SUCCESS} ${GREEN}Test email sent! Check MailHog UI at http://localhost:8025${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

config_mysql() {
	echo -e "${YELLOW}Setting up MySQL...${NC}"
	
	# Create MySQL directories
	if [[ ! -d $INSTALL_DIR/mysql ]]; then
		mkdir -p "$INSTALL_DIR/mysql"
		echo -e "${CHECK} ${GREEN}MySQL directory created!${NC}"
	fi
	
	if [[ ! -d $INSTALL_DIR/mysql/data ]]; then
		mkdir -p "$INSTALL_DIR/mysql/data"
		echo -e "${CHECK} ${GREEN}MySQL data directory created!${NC}"
	fi
	
	# Create MySQL configuration file
	if [[ ! -f $INSTALL_DIR/mysql/my.cnf ]]; then
		echo -e "${YELLOW}Creating MySQL config...${NC}"
		cat > "$INSTALL_DIR/mysql/my.cnf" <<EOF
[mysqld]
datadir = $INSTALL_DIR/mysql/data
socket = $INSTALL_DIR/mysql/mysql.sock
user = $(whoami)
bind-address = 127.0.0.1
port = 3306
skip-external-locking
default_storage_engine = InnoDB
innodb_file_per_table = 1
innodb_log_file_size = 64M
log-error = $INSTALL_DIR/mysql/mysql.log
pid-file = $INSTALL_DIR/mysql/mysql.pid
tmpdir = $INSTALL_DIR/mysql

[mysqld_safe]
log-error = $INSTALL_DIR/mysql/mysql.log
pid-file = $INSTALL_DIR/mysql/mysql.pid

[mysql]
socket = $INSTALL_DIR/mysql/mysql.sock

[client]
socket = $INSTALL_DIR/mysql/mysql.sock
EOF
		echo -e "${CHECK} ${GREEN}MySQL config created!${NC}"
	fi

	# Create log file
	if [[ ! -f $INSTALL_DIR/mysql/mysql.log ]]; then
		touch "$INSTALL_DIR/mysql/mysql.log"
		echo -e "${CHECK} ${GREEN}MySQL log file created!${NC}"
	fi

	# Create PID file
	if [[ ! -f $INSTALL_DIR/mysql/mysql.pid ]]; then
		touch "$INSTALL_DIR/mysql/mysql.pid"
		echo -e "${CHECK} ${GREEN}MySQL PID file created!${NC}"
	fi
	
	echo -e "${SUCCESS} ${GREEN}MySQL configuration complete!${NC}"
}

# Set initial MySQL root password
set_mysql_initial_password() {
	echo -e "${YELLOW}Setting initial MySQL root password...${NC}"
	nix-portable nix-shell -p mysql --run "
		mysqladmin --socket=$INSTALL_DIR/mysql/mysql.sock -u root password '$MYSQL_DEFAULT_PASSWORD'
	" 2>/dev/null || true
	echo -e "${CHECK} ${GREEN}MySQL root password set to default: $MYSQL_DEFAULT_PASSWORD${NC}"
}

# Change MySQL root password
mysql_change_password() {
	echo -e "${YELLOW}Change MySQL Root Password${NC}"
	
	if ! pgrep -af "mysqld" > /dev/null; then
		echo -e "${ERROR} ${RED}MySQL server is not running! Please start MySQL first.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	
	echo -e "${BLUE}Enter current password:${NC}"
	read -s CURRENT_PASSWORD
	echo
	
	echo -e "${BLUE}Enter new password:${NC}"
	read -s NEW_PASSWORD
	echo
	
	echo -e "${BLUE}Confirm new password:${NC}"
	read -s CONFIRM_PASSWORD
	echo
	
	if [[ "$NEW_PASSWORD" != "$CONFIRM_PASSWORD" ]]; then
		echo -e "${ERROR} ${RED}Passwords do not match!${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	
	echo -e "${YELLOW}Changing password...${NC}"
	nix-portable nix-shell -p mysql --run "
		mysqladmin --socket=$INSTALL_DIR/mysql/mysql.sock -u root -p'$CURRENT_PASSWORD' password '$NEW_PASSWORD'
	" 2>/dev/null
	
	if [[ $? -eq 0 ]]; then
		echo -e "${SUCCESS} ${GREEN}Password changed successfully!${NC}"
	else
		echo -e "${ERROR} ${RED}Failed to change password. Check your current password.${NC}"
	fi
	read -n 1 -s -p "Press any key to continue..."
}

# Reset MySQL root password (when forgotten)
mysql_reset_password() {
	echo -e "${YELLOW}Reset MySQL Root Password${NC}"
	echo -e "${RED}WARNING: This will stop MySQL, reset the root password to '$MYSQL_DEFAULT_PASSWORD', and restart MySQL.${NC}"
	echo
	echo -e "${YELLOW}Do you want to continue? (y/n)${NC}"
	read -n 1 -r
	echo
	
	if [[ ! $REPLY =~ ^[Yy]$ ]]; then
		echo -e "${YELLOW}Password reset cancelled.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 0
	fi
	
	echo -e "${YELLOW}Stopping MySQL...${NC}"
	stop_mysql 2>/dev/null
	
	echo -e "${YELLOW}Starting MySQL in skip-grant-tables mode...${NC}"
	nix-portable nix-shell -p mysql --run "
		mysqld_safe --defaults-file=$INSTALL_DIR/mysql/my.cnf --skip-grant-tables &
	" > /dev/null 2>&1 &
	sleep 3
	
	echo -e "${YELLOW}Resetting root password...${NC}"
	nix-portable nix-shell -p mysql --run "
		mysql --socket=$INSTALL_DIR/mysql/mysql.sock -u root <<-EOSQL
			FLUSH PRIVILEGES;
			ALTER USER 'root'@'localhost' IDENTIFIED BY '$MYSQL_DEFAULT_PASSWORD';
			FLUSH PRIVILEGES;
		EOSQL
	" 2>/dev/null
	
	echo -e "${YELLOW}Restarting MySQL normally...${NC}"
	stop_mysql 2>/dev/null
	sleep 2
	start_mysql 2>/dev/null
	
	echo -e "${SUCCESS} ${GREEN}Password reset to: $MYSQL_DEFAULT_PASSWORD${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

# Reset MySQL database data (wipe and reinitialize)
mysql_reset_data() {
	echo -e "${RED}‚ö†Ô∏è  WARNING: Reset MySQL Database Data ‚ö†Ô∏è${NC}"
	echo -e "${RED}This will DELETE ALL MySQL data and reinitialize the database!${NC}"
	echo -e "${RED}All databases, tables, and data will be permanently lost!${NC}"
	echo
	echo -e "${YELLOW}Type 'RESET' to confirm:${NC}"
	read CONFIRM
	
	if [[ "$CONFIRM" != "RESET" ]]; then
		echo -e "${YELLOW}Reset cancelled.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 0
	fi
	
	echo -e "${YELLOW}Stopping MySQL...${NC}"
	stop_mysql 2>/dev/null
	sleep 2
	
	echo -e "${YELLOW}Removing MySQL data directory...${NC}"
	rm -rf "$INSTALL_DIR/mysql/data"
	mkdir -p "$INSTALL_DIR/mysql/data"
	echo -e "${CHECK} ${GREEN}Data directory cleared!${NC}"
	
	echo -e "${YELLOW}Reinitializing MySQL database...${NC}"
	nix-portable nix-shell -p mysql --run "
		mysql_install_db --defaults-file=$INSTALL_DIR/mysql/my.cnf --datadir=$INSTALL_DIR/mysql/data --user=\$(whoami)
	" 2>/dev/null
	echo -e "${CHECK} ${GREEN}MySQL database reinitialized!${NC}"
	
	echo -e "${YELLOW}Starting MySQL...${NC}"
	nix-portable nix-shell -p mysql --run "
		mysqld_safe --defaults-file=$INSTALL_DIR/mysql/my.cnf &
	" > /dev/null 2>&1 &
	sleep 3
	
	echo -e "${YELLOW}Setting default root password...${NC}"
	set_mysql_initial_password
	
	echo -e "${SUCCESS} ${GREEN}MySQL data reset complete! Default password: $MYSQL_DEFAULT_PASSWORD${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

setup_apache_php() {
  echo "php82" > $CONF_DIR/php-version.conf
 	PHP_VERSION=$(<$CONF_DIR/php-version.conf)
  install_apache
  install_php
}

setup_configs() {
	APACHE_PATH=$(nix-portable nix-shell -p apacheHttpd --run "echo \$(dirname \$(dirname \$(which httpd)))" 2>/dev/null)
	echo -e "\n${GEAR} ${YELLOW}Setting up ApacheNest configs...${NC}"
	
	echo -e "${YELLOW}Creating PHP-FPM config...${NC}"
	cat > "$CONF_DIR/php-fpm.conf" <<EOF
[global]
error_log = $INSTALL_DIR/php-fpm.log

[www]
listen = 127.0.0.1:9000
listen.allowed_clients = 127.0.0.1
pm = dynamic
pm.max_children = 5
pm.start_servers = 2
pm.min_spare_servers = 1
pm.max_spare_servers = 3
chdir = /
EOF

	echo -e "${YELLOW}Creating Apache config...${NC}"
	cat > "$CONF_DIR/httpd.conf" <<EOF
ServerName 127.0.0.1
ServerRoot "$INSTALL_DIR/apache"
Listen 8080
LoadModule mpm_event_module $APACHE_PATH/modules/mod_mpm_event.so
LoadModule proxy_module $APACHE_PATH/modules/mod_proxy.so
LoadModule proxy_fcgi_module $APACHE_PATH/modules/mod_proxy_fcgi.so
LoadModule dir_module $APACHE_PATH/modules/mod_dir.so
LoadModule mime_module $APACHE_PATH/modules/mod_mime.so
LoadModule authz_core_module $APACHE_PATH/modules/mod_authz_core.so
LoadModule unixd_module $APACHE_PATH/modules/mod_unixd.so

DocumentRoot "$WWW_DIR"
<Directory "$WWW_DIR">
		Require all granted
</Directory>

DirectoryIndex index.php index.html

<FilesMatch \.php$>
		SetHandler "proxy:fcgi://127.0.0.1:9000"
</FilesMatch>

TypesConfig $APACHE_PATH/conf/mime.types
EOF
	echo -e "${SUCCESS} ${GREEN}ApacheNest config ready!${NC}\n"
}

setup_mysql() {
	echo -e "${YELLOW}Installing MySQL ${NC}"
	install_mysql
	config_mysql
}

setup_apachenest(){
	setup_nix_portable
	setup_apache_php
	setup_configs

	setup_mysql
	setup_mailhog
}

select_php() {
	stop_php
  local CURRENT_VERSION=$PHP_VERSION
  [[ -f php-version.conf ]] && CURRENT_VERSION=$(<php-version.conf)
  
	TMP_OUT=$(mktemp)
	(
		nix-portable nix search nixpkgs "php-with-extensions" \
		  --exclude "apacheHttpdPackages" --json 2>/dev/null | \
		  jq -r 'keys[] | select(test("php8[1-4]$")) | sub(".*\\."; "")' \
		  > "$TMP_OUT"
	) &
	CMD_PID=$!
	spinner "$CMD_PID"
	PHP_VERSIONS=$(<"$TMP_OUT")
	rm "$TMP_OUT"

  local SORTED_VERSIONS
  SORTED_VERSIONS=$(
    printf "%s\n" $CURRENT_VERSION $PHP_VERSIONS \
      | awk '!seen[$0]++'
  )

 
  local SELECTED_VERSION=$(printf "%s\n" $SORTED_VERSIONS | fzf --border --highlight-line --height=10% --layout=reverse --header-lines=1 --prompt="Select PHP version > ")
	[[ -z $SELECTED_VERSION ]] && return
	PHP_VERSION=$SELECTED_VERSION
  echo "$SELECTED_VERSION" > $CONF_DIR/php-version.conf
  echo -e "${CHECK} ${GREEN}PHP version selected!${NC}"
  install_php
}

# Show current PHP version and path info
php_info() {
	echo -e "${BLUE}=== PHP Information ===${NC}\n"
	echo -e "${YELLOW}Current Version:${NC} $PHP_VERSION"
	echo
	
	nix-portable nix-shell -p $PHP_VERSION --run "
		echo -e '${YELLOW}PHP Version Details:${NC}'
		php -v
		echo
		echo -e '${YELLOW}PHP Binary Path:${NC}'
		which php
		echo
		echo -e '${YELLOW}PHP-FPM Binary Path:${NC}'
		which php-fpm
		echo
		echo -e '${YELLOW}PHP Configuration File:${NC}'
		php --ini | head -5
	" 2>/dev/null
	
	echo
	read -n 1 -s -p "Press any key to continue..."
}

# List installed PHP extensions
php_extensions() {
	echo -e "${BLUE}=== PHP Extensions ===${NC}\n"
	echo -e "${YELLOW}Installed extensions for $PHP_VERSION:${NC}\n"
	
	nix-portable nix-shell -p $PHP_VERSION --run "
		php -m
	" 2>/dev/null | column
	
	echo
	read -n 1 -s -p "Press any key to continue..."
}

# View phpinfo() in browser
php_phpinfo() {
	echo -e "${YELLOW}Creating phpinfo page...${NC}"
	
	# Create phpinfo file
	echo '<?php phpinfo(); ?>' > "$WWW_DIR/phpinfo.php"
	echo -e "${CHECK} ${GREEN}phpinfo.php created in $WWW_DIR${NC}"
	
	if ! pgrep -af "$CONF_DIR/httpd.conf" > /dev/null || ! pgrep -af "$CONF_DIR/php-fpm.conf" > /dev/null; then
		echo -e "${YELLOW}Apache or PHP-FPM is not running.${NC}"
		echo -e "${YELLOW}Start both services to view phpinfo in browser.${NC}"
	else
		echo -e "${BLUE}Opening phpinfo in browser...${NC}"
		echo -e "${GREEN}URL: http://localhost:8080/phpinfo.php${NC}"
		
		if command -v xdg-open &> /dev/null; then
			xdg-open "http://localhost:8080/phpinfo.php" 2>/dev/null &
		elif command -v open &> /dev/null; then
			open "http://localhost:8080/phpinfo.php" 2>/dev/null &
		fi
	fi
	
	read -n 1 -s -p "Press any key to continue..."
}

# Edit PHP configuration
php_edit_config() {
	echo -e "${BLUE}=== PHP Configuration ===${NC}\n"
	
	# Create custom php.ini if not exists
	if [[ ! -f $CONF_DIR/php.ini ]]; then
		echo -e "${YELLOW}Creating custom php.ini...${NC}"
		cat > "$CONF_DIR/php.ini" <<EOF
; ApacheNest Custom PHP Configuration
; Add your PHP settings here

[PHP]
; Maximum execution time of each script, in seconds
max_execution_time = 300

; Maximum amount of memory a script may consume
memory_limit = 256M

; Maximum size of POST data that PHP will accept
post_max_size = 64M

; Maximum allowed size for uploaded files
upload_max_filesize = 64M

; Maximum number of files that can be uploaded via a single request
max_file_uploads = 20

; Default timezone
date.timezone = UTC

; Error reporting
error_reporting = E_ALL
display_errors = On
display_startup_errors = On
log_errors = On
error_log = $INSTALL_DIR/php-error.log

[opcache]
opcache.enable = 1
opcache.memory_consumption = 128
opcache.interned_strings_buffer = 8
opcache.max_accelerated_files = 10000
opcache.validate_timestamps = 1
opcache.revalidate_freq = 2

[Session]
session.save_path = $INSTALL_DIR/sessions

[mail function]
; For MailHog
SMTP = localhost
smtp_port = 1025
EOF
		
		# Create sessions directory
		mkdir -p "$INSTALL_DIR/sessions"
		echo -e "${CHECK} ${GREEN}php.ini created!${NC}"
	fi
	
	echo -e "${YELLOW}PHP Configuration File: $CONF_DIR/php.ini${NC}\n"
	
	# Show current settings
	echo -e "${BLUE}Current Settings:${NC}"
	cat "$CONF_DIR/php.ini" | grep -v "^;" | grep -v "^$" | head -20
	echo -e "\n...(truncated)\n"
	
	echo -e "${YELLOW}Options:${NC}"
	echo "1) Edit php.ini with nano"
	echo "2) Edit php.ini with vim"
	echo "3) View full php.ini"
	echo "4) Reset to defaults"
	echo "5) Back"
	echo
	read -p "Select option: " OPTION
	
	case $OPTION in
		1)
			nano "$CONF_DIR/php.ini" ;;
		2)
			vim "$CONF_DIR/php.ini" ;;
		3)
			less "$CONF_DIR/php.ini" ;;
		4)
			rm -f "$CONF_DIR/php.ini"
			echo -e "${CHECK} ${GREEN}php.ini reset. Will be recreated with defaults.${NC}"
			php_edit_config ;;
		*)
			return ;;
	esac
	
	echo -e "\n${YELLOW}Note: Restart PHP-FPM for changes to take effect.${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

# View PHP logs
php_logs() {
	echo -e "${BLUE}=== PHP Logs ===${NC}\n"
	
	echo -e "${YELLOW}Select log to view:${NC}"
	echo "1) PHP-FPM Log ($INSTALL_DIR/php-fpm.log)"
	echo "2) PHP Error Log ($INSTALL_DIR/php-error.log)"
	echo "3) Tail PHP-FPM Log (live)"
	echo "4) Clear all PHP logs"
	echo "5) Back"
	echo
	read -p "Select option: " OPTION
	
	case $OPTION in
		1)
			if [[ -f $INSTALL_DIR/php-fpm.log ]]; then
				less "$INSTALL_DIR/php-fpm.log"
			else
				echo -e "${YELLOW}No PHP-FPM log file found.${NC}"
				read -n 1 -s -p "Press any key to continue..."
			fi ;;
		2)
			if [[ -f $INSTALL_DIR/php-error.log ]]; then
				less "$INSTALL_DIR/php-error.log"
			else
				echo -e "${YELLOW}No PHP error log file found.${NC}"
				read -n 1 -s -p "Press any key to continue..."
			fi ;;
		3)
			echo -e "${YELLOW}Tailing PHP-FPM log (Ctrl+C to exit)...${NC}\n"
			tail -f "$INSTALL_DIR/php-fpm.log" 2>/dev/null || echo "Log file not found." ;;
		4)
			echo -e "${YELLOW}Clearing PHP logs...${NC}"
			> "$INSTALL_DIR/php-fpm.log" 2>/dev/null
			> "$INSTALL_DIR/php-error.log" 2>/dev/null
			echo -e "${CHECK} ${GREEN}PHP logs cleared!${NC}"
			read -n 1 -s -p "Press any key to continue..." ;;
		*)
			return ;;
	esac
}

# Clear OPcache
php_clear_opcache() {
	if ! pgrep -af "$CONF_DIR/php-fpm.conf" > /dev/null; then
		echo -e "${ERROR} ${RED}PHP-FPM is not running! Please start PHP first.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	
	echo -e "${YELLOW}Clearing OPcache...${NC}"
	
	# Create a temporary script to clear opcache
	cat > "$WWW_DIR/opcache_clear.php" <<'EOF'
<?php
if (function_exists('opcache_reset')) {
    opcache_reset();
    echo "OPcache cleared successfully!";
} else {
    echo "OPcache is not available.";
}
?>
EOF
	
	# Call the script
	curl -s "http://localhost:8080/opcache_clear.php" 2>/dev/null || echo "Could not connect to server"
	echo
	
	# Remove the temporary script
	rm -f "$WWW_DIR/opcache_clear.php"
	
	echo -e "${CHECK} ${GREEN}OPcache clear attempted!${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

# PHP test script
php_test() {
	echo -e "${YELLOW}Running PHP test...${NC}\n"
	
	nix-portable nix-shell -p $PHP_VERSION --run "
		echo '=== PHP Syntax Check ==='
		php -v
		echo
		echo '=== Testing PHP execution ==='
		php -r 'echo \"PHP is working! Current time: \" . date(\"Y-m-d H:i:s\") . \"\\n\";'
		echo
		echo '=== Checking common extensions ==='
		php -r '
			\$extensions = [\"pdo\", \"mysqli\", \"json\", \"mbstring\", \"curl\", \"openssl\", \"zip\", \"gd\"];
			foreach (\$extensions as \$ext) {
				\$status = extension_loaded(\$ext) ? \"‚úì\" : \"‚úó\";
				echo \"  \$status \$ext\\n\";
			}
		'
	" 2>/dev/null
	
	echo
	read -n 1 -s -p "Press any key to continue..."
}

start_apache(){
	nix-portable nix-shell -p apacheHttpd --run "
		httpd -f $CONF_DIR/httpd.conf &
	"
	clear
}

start_php(){
	nix-portable nix-shell -p $PHP_VERSION  --run "
		php-fpm -y $CONF_DIR/php-fpm.conf &
	"
	clear
}

stop_apache(){
	if pgrep -af "$CONF_DIR/httpd.conf" > /dev/null; then 
		pkill -f "$CONF_DIR/httpd.conf"
		sleep 1
	fi
	clear
}

stop_php(){
	if pgrep -af "$CONF_DIR/php-fpm.conf" > /dev/null; then 
		pkill -f "$CONF_DIR/php-fpm.conf"
		sleep 1
	fi
	clear
}

start_mysql(){
	# Ensure MySQL is configured first
	config_mysql
	
	local FIRST_INIT=false
	
	# Initialize database if not already done
	if [[ ! -f $INSTALL_DIR/mysql/data/mysql/db.opt ]]; then
		echo -e "${YELLOW}Initializing MySQL database...${NC}"
		nix-portable nix-shell -p mysql --run "
			mysql_install_db --defaults-file=$INSTALL_DIR/mysql/my.cnf --datadir=$INSTALL_DIR/mysql/data --user=\$(whoami)
		" 2>/dev/null
		echo -e "${CHECK} ${GREEN}MySQL database initialized!${NC}"
		FIRST_INIT=true
	fi
	
	MYSQLD_LOG="$INSTALL_DIR/mysql/mysql.log"
	echo -e "${YELLOW}Starting MySQL...${NC}"
	nix-portable nix-shell -p mysql --run "
		mysqld_safe --defaults-file=$INSTALL_DIR/mysql/my.cnf &
	" > "$MYSQLD_LOG" 2>&1 &
	sleep 2
	echo -e "${CHECK} ${GREEN}MySQL started!${NC}"
	
	# Set default password on first initialization
	if [[ "$FIRST_INIT" == true ]]; then
		sleep 1
		set_mysql_initial_password
	fi
	clear
}

stop_mysql(){
	echo -e "${YELLOW}Stopping MySQL...${NC}"
	
	# Try graceful shutdown first using mysqladmin
	if pgrep -af "mysqld" > /dev/null; then
		nix-portable nix-shell -p mysql --run "
			mysqladmin --socket=$INSTALL_DIR/mysql/mysql.sock shutdown
		" 2>/dev/null || true
		sleep 2
	fi
	
	# Force kill if still running
	if pgrep -af "mysqld" > /dev/null; then 
		echo -e "${YELLOW}Force stopping MySQL processes...${NC}"
		pkill -f "mysqld_safe" 2>/dev/null || true
		pkill -f "mysqld" 2>/dev/null || true
		sleep 2
	fi
	
	# Clean up PID file
	if [[ -f $INSTALL_DIR/mysql/mysql.pid ]]; then
		rm -f "$INSTALL_DIR/mysql/mysql.pid"
	fi
	
	echo -e "${CHECK} ${GREEN}MySQL stopped!${NC}"
	clear
}

restart_apache(){
	stop_apache && sleep 1
	start_apache
}

restart_php(){
	stop_php && sleep 1
	start_php
}


restart_all() {
	restart_apache
	restart_php
	restart_mysql
	restart_mailhog
}

start_all(){
	if ! pgrep -af "$CONF_DIR/httpd.conf" > /dev/null; then 
		start_apache
	fi
	if ! pgrep -af "$CONF_DIR/php-fpm.conf" > /dev/null; then 
		start_php
	fi
	if ! pgrep -af "mysqld" > /dev/null; then 
		start_mysql
	fi
	if ! pgrep -af "MailHog" > /dev/null; then 
		start_mailhog
	fi
	clear
}

stop_all(){
	stop_apache
	stop_php
	stop_mysql
	stop_mailhog
	clear
}

restart(){
	restart_apache
	restart_php
	restart_mysql
	restart_mailhog
	clear
}

all_menu(){
	clear
	local ACTIONS
	while true; do
		remove_dblock
		printf "\n${BLUE}${ROCKET} ${TITLE} ${ROCKET}${NC}\n"

		ACTIONS=("Start" "Stop" "Restart" "Refresh")
		
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --highlight-line --height=10% --layout=reverse --prompt="All > ")
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"Start")
			 	start_all & spinner ;;
			"Stop")
			 	stop_all & spinner ;;
			"Restart")
				restart_all & spinner ;;
			"Refresh")
				refresh_menu ;;
		esac
	done
	clear
}

apache_menu(){
	local ACTIONS
	while true; do
		clear
		remove_dblock
		printf "\n${BLUE}${ROCKET} ${TITLE} ${ROCKET}${NC}\n"
		ACTIONS=($(if ! pgrep -af "$CONF_DIR/httpd.conf" > /dev/null; then 
			echo Start
		else
			echo Stop
		fi) "Restart" "Refresh")
		
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --highlight-line --height=10% --layout=reverse --prompt="Apache > ")
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"Start")
			 	start_apache & spinner ;;
			"Stop")
			 	stop_apache & spinner ;;
			"Restart")
				restart_apache & spinner ;;
			"Refresh")
				refresh_menu ;;
		esac
	done
	clear
}

php_menu(){
	clear
	local ACTIONS
	while true; do
		remove_dblock
		printf "\n${BLUE}${ROCKET} ${TITLE} - PHP ${ROCKET}${NC}\n"
		echo -e "${YELLOW}Current Version: ${GREEN}$PHP_VERSION${NC}\n"
		
		ACTIONS=($(if ! pgrep -af "$CONF_DIR/php-fpm.conf" > /dev/null; then 
			echo Start
		else
			echo Stop
		fi) "Restart" "Change Version" "PHP Info" "Extensions" "phpinfo()" "Configuration" "Logs" "Clear OPcache" "Test PHP" "Refresh")
		
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --highlight-line --height=18% --layout=reverse --prompt="PHP > ")
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"Start")
			 	start_php & spinner ;;
			"Stop")
			 	stop_php & spinner ;;
			"Restart")
				restart_php & spinner ;;
			"Change Version")
				select_php ;;
			"PHP Info")
				php_info ;;
			"Extensions")
				php_extensions ;;
			"phpinfo()")
				php_phpinfo ;;
			"Configuration")
				php_edit_config ;;
			"Logs")
				php_logs ;;
			"Clear OPcache")
				php_clear_opcache ;;
			"Test PHP")
				php_test ;;
			"Refresh")
				refresh_menu ;;
		esac
	done
	clear
}

restart_mysql() {
	clear
	stop_mysql
	start_mysql
}

mysql_menu() {
	clear
	local ACTIONS
	echo -e "\n${BLUE}${ROCKET} ${TITLE} ${ROCKET}${NC}"
	while true; do
		remove_dblock
		ACTIONS=("Start" "Stop" "Restart" "Change Password" "Reset Password" "Reset Data" "Config" "Refresh")
		
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --highlight-line --height=15% --layout=reverse --prompt="MySQL > ")
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"Start")
			 	start_mysql & spinner ;;
			"Stop")
			 	stop_mysql & spinner ;;
			"Restart")
				restart_mysql & spinner ;;
			"Change Password")
				mysql_change_password ;;
			"Reset Password")
				mysql_reset_password ;;
			"Reset Data")
				mysql_reset_data ;;
			"Config")
				config_mysql ;;
			"Refresh")
				refresh_menu ;;
		esac
	done
	clear
}

mail_menu() {
	clear
	local ACTIONS
	echo -e "\n${BLUE}${ROCKET} ${TITLE} - Mail Server ${ROCKET}${NC}"
	echo -e "${YELLOW}MailHog - Email Testing Tool${NC}"
	echo -e "${BLUE}SMTP: localhost:1025 | Web UI: http://localhost:8025${NC}\n"
	while true; do
		remove_dblock
		ACTIONS=($(if ! pgrep -af "MailHog" > /dev/null; then 
			echo Start
		else
			echo Stop
		fi) "Restart" "Open Web UI" "Send Test Email" "Configure PHP" "Config" "Refresh")
		
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --highlight-line --height=15% --layout=reverse --prompt="Mail > ")
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"Start")
			 	start_mailhog & spinner ;;
			"Stop")
			 	stop_mailhog & spinner ;;
			"Restart")
				restart_mailhog & spinner ;;
			"Open Web UI")
				open_mailhog_ui ;;
			"Send Test Email")
				test_email ;;
			"Configure PHP")
				config_php_mail ;;
			"Config")
				config_mailhog ;;
			"Refresh")
				refresh_menu ;;
		esac
	done
	clear
}

refresh_menu() {
	clear
}

main_menu(){
	clear
	local ACTIONS
	ACTIONS=("All" "Apache" "PHP" "MySQL" "Mail" "Refresh" "Settings" "About" "Exit")
	while true; do
		remove_dblock
		printf "\n${BLUE}${ROCKET} ${TITLE} ${ROCKET}${NC}\n"
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --highlight-line --height=12% --layout=reverse \
		--preview-window=80%:wrap --preview='
		SELECTED={}
		if [[ $SELECTED == "All" ]]; then
			echo -e "Apache status: \t'$(if ! pgrep -af "$CONF_DIR/httpd.conf" > /dev/null; then 
				echo üü•Inactive 
			else
				echo üü©Active 
			fi)'"
			echo -e "PHP status: \t'$(if ! pgrep -af "$CONF_DIR/php-fpm.conf" > /dev/null; then 
				echo üü•Inactive 
			else
				echo üü©Active 
			fi)'"
			echo -e "MySQL status: \t'$(if ! pgrep -af "mysqld" > /dev/null; then 
				echo üü•Inactive 
			else
				echo üü©Active 
			fi)'"
			echo -e "Mail status: \t'$(if ! pgrep -af "MailHog" > /dev/null; then 
				echo üü•Inactive 
			else
				echo üü©Active 
			fi)'"
		fi
		if [[ $SELECTED == "Apache" ]]; then
			echo "Status: '$(if ! pgrep -af "$CONF_DIR/httpd.conf" > /dev/null; then 
				echo üü•Inactive 
			else
				echo üü©Active 
			fi)'"
		  nix-portable nix-shell -p apacheHttpd --run "httpd -v" 2>/dev/null
		  echo -e "\n===Logs===\n"
		  [[ -f '$INSTALL_DIR'/apache/logs/error_log ]] && cat '$INSTALL_DIR'/apache/logs/error_log
		fi
		if [[ $SELECTED == "PHP" ]]; then
			echo "Status: '$(if ! pgrep -af "$CONF_DIR/php-fpm.conf" > /dev/null; then 
				echo üü•Inactive 
			else
				echo üü©Active 
			fi)'"
		  nix-portable nix-shell -p '$PHP_VERSION' --run "php -v" 2>/dev/null
		  echo -e "\n===Logs===\n"
		  [[ -f '$INSTALL_DIR'/php-fpm.log ]] && cat '$INSTALL_DIR'/php-fpm.log
		fi
		if [[ $SELECTED == "MySQL" ]]; then
			echo "Status: '$(if ! pgrep -af "mysqld" > /dev/null; then 
				echo üü•Inactive 
			else
				echo üü©Active 
			fi)'"
		  nix-portable nix-shell -p mysql --run "mysql --version" 2>/dev/null
		  echo -e "\n===Logs===\n"
		  [[ -f '$INSTALL_DIR'/mysql/mysql.log ]] && cat '$INSTALL_DIR'/mysql/mysql.log
		fi
		if [[ $SELECTED == "Mail" ]]; then
			echo "Status: '$(if ! pgrep -af "MailHog" > /dev/null; then 
				echo üü•Inactive 
			else
				echo üü©Active 
			fi)'"
			echo -e "\nMailHog - Email Testing Tool"
			echo -e "SMTP Server: localhost:1025"
			echo -e "Web UI: http://localhost:8025"
			echo -e "\n===Logs===\n"
			[[ -f '$INSTALL_DIR'/mailhog/mailhog.log ]] && tail -20 '$INSTALL_DIR'/mailhog/mailhog.log
		fi
		')
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"All")
				all_menu ;;
			"Apache")
			 	apache_menu ;;
			"PHP")
			 	php_menu ;;
			"MySQL")
				mysql_menu ;;
			"Mail")
				mail_menu ;;
			"Refresh")
				refresh_menu ;;
			"Settings")
				echo Settings ;;
			"About")
				about ;;
			"Exit")
				bye ;;
		esac
	done
	clear
}

about() {
	echo -e "\n${BLUE}${ROCKET} ${TITLE} ${ROCKET}${NC}"
	echo -e "${YELLOW}Authors: ${GREEN} ${AUTHORS} ${NC}"

	read -n 1 -s
	clear
}

bye() {
	echo -e "\nBye! ${SUCCESS} ${GREEN}Thank you for using ApacheNest!${NC}\n"
	exit 0
}

trap bye SIGINT

configure_env
[[ ! -d $INSTALL_DIR ]] && setup_apachenest
remove_dblock
main_menu
