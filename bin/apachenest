#!/usr/bin/env bash
set -Eeuo pipefail

TITLE="ApacheNest"
AUTHORS="JianZCar and aceday"

INSTALL_DIR="$HOME/Documents/.apachenest"
WWW_DIR="$INSTALL_DIR/www"
CONF_DIR="$INSTALL_DIR/conf"

GREEN="\033[0;32m"
BLUE="\033[0;34m"
YELLOW="\033[1;33m"
RED="\033[0;31m"
NC="\033[0m"

CHECK="[OK]"
ERROR="[ERR]"
ROCKET="[APP]"
GEAR="[CFG]"
DOWNLOAD="[DL]"
HOURGLASS="[WAIT]"
SUCCESS="[DONE]"
VERBOSE_MODE="0"

spinner() {
	local pid="$1"
	local delay="0.10"
	local spinstr='-\|/'
	while kill -0 "$pid" 2>/dev/null; do
		local char="${spinstr:0:1}"
		spinstr="${spinstr:1}${char}"
		printf " %s " "$char"
		sleep "$delay"
		printf "\r"
	done
	printf "\r"
}

run_with_spinner() {
	("$@") &
	local cmd_pid=$!
	spinner "$cmd_pid"
	wait "$cmd_pid"
}

require_commands() {
	local required=("fzf" "jq" "curl" "nc")
	local missing=()
	local command_name
	for command_name in "${required[@]}"; do
		if ! command -v "$command_name" >/dev/null 2>&1; then
			missing+=("$command_name")
		fi
	done
	if [[ ${#missing[@]} -gt 0 ]]; then
		echo -e "${ERROR} ${RED}Missing required commands: ${missing[*]}${NC}"
		echo -e "${YELLOW}Install missing dependencies and rerun ApacheNest.${NC}"
		exit 1
	fi
	if ! command -v nix-portable >/dev/null 2>&1 && [[ ! -x "$INSTALL_DIR/bin/nix-portable" ]]; then
		echo -e "${ERROR} ${RED}nix-portable is not available.${NC}"
		echo -e "${YELLOW}Run initial setup or place nix-portable in PATH or $INSTALL_DIR/bin.${NC}"
		exit 1
	fi
}

require_interactive_tty() {
	if [[ ! -t 0 || ! -t 1 ]]; then
		echo "ApacheNest requires an interactive TTY terminal."
		echo "Run this script in an interactive shell to use menu mode."
		exit 2
	fi
}

print_usage() {
	echo "Usage: apachenest [-v|--verbose]"
}

parse_cli_arguments() {
	local argument
	for argument in "$@"; do
		case "$argument" in
			-v|--verbose)
				VERBOSE_MODE="1" ;;
			*)
				print_usage
				exit 1 ;;
		esac
	done
}

is_running() {
	local pattern="$1"
	pgrep -af "$pattern" >/dev/null 2>&1
}

service_status_label() {
	local pattern="$1"
	if is_running "$pattern"; then
		echo "ACTIVE"
	else
		echo "INACTIVE"
	fi
}

tool_status_label() {
	local command_name="$1"
	if command -v "$command_name" >/dev/null 2>&1; then
		echo "AVAILABLE"
	else
		echo "MISSING"
	fi
}

wait_until_running() {
	local pattern="$1"
	local attempts="${2:-20}"
	local delay="${3:-0.25}"
	local i
	for ((i=0; i<attempts; i++)); do
		if is_running "$pattern"; then
			return 0
		fi
		sleep "$delay"
	done
	return 1
}

wait_until_stopped() {
	local pattern="$1"
	local attempts="${2:-20}"
	local delay="${3:-0.25}"
	local i
	for ((i=0; i<attempts; i++)); do
		if ! is_running "$pattern"; then
			return 0
		fi
		sleep "$delay"
	done
	return 1
}

configure_env() {
	export NP_LOCATION="$INSTALL_DIR"
	export PATH="$PATH:$INSTALL_DIR/bin"
	export NP_GIT
	NP_GIT="$(command -v git)"
	if [[ -f $CONF_DIR/php-version.conf ]]; then
		PHP_VERSION=$(<$CONF_DIR/php-version.conf)
	fi
}

settings_file_path() {
	echo "$CONF_DIR/settings.conf"
}

settings_ensure_file() {
	mkdir -p "$CONF_DIR"
	local settings_file
	settings_file="$(settings_file_path)"
	if [[ ! -f "$settings_file" ]]; then
		printf "php_version=php82\n" > "$settings_file"
	fi
}

settings_get_value() {
	local key_name="$1"
	local default_value="$2"
	settings_ensure_file
	local settings_file
	settings_file="$(settings_file_path)"
	local matched_value
	matched_value="$(awk -F '=' -v key_name="$key_name" '$1 == key_name {print $2; exit}' "$settings_file")"
	if [[ -n "$matched_value" ]]; then
		echo "$matched_value"
	else
		echo "$default_value"
	fi
}

settings_set_value() {
	local key_name="$1"
	local key_value="$2"
	settings_ensure_file
	local settings_file
	settings_file="$(settings_file_path)"
	local temp_file
	temp_file="$(mktemp)"
	awk -F '=' -v key_name="$key_name" -v key_value="$key_value" '
	BEGIN { found = 0 }
	$1 == key_name {
		print key_name "=" key_value
		found = 1
		next
	}
	{ print $0 }
	END {
		if (found == 0) {
			print key_name "=" key_value
		}
	}
	' "$settings_file" > "$temp_file"
	mv "$temp_file" "$settings_file"
}

settings_load_runtime_values() {
	settings_ensure_file
	local configured_php_version
	configured_php_version="$(settings_get_value "php_version" "php82")"
	if [[ -n "$configured_php_version" ]]; then
		PHP_VERSION="$configured_php_version"
		if [[ ! -f "$CONF_DIR/php-version.conf" ]] || [[ "$(cat "$CONF_DIR/php-version.conf")" != "$configured_php_version" ]]; then
			printf "%s\n" "$configured_php_version" > "$CONF_DIR/php-version.conf"
		fi
	fi
}

discover_php_versions() {
	local current_version="$1"
	local temp_output
	temp_output="$(mktemp)"
	(
		nix-portable nix search nixpkgs "php-with-extensions" \
		  --exclude "apacheHttpdPackages" --json 2>/dev/null | \
		  jq -r 'keys[] | select(test("php8[1-4]$")) | sub(".*\\."; "")' \
		  > "$temp_output"
	) &
	local command_pid=$!
	spinner "$command_pid"
	if ! wait "$command_pid"; then
		rm -f "$temp_output"
		return 1
	fi
	local discovered_versions
	discovered_versions="$(<"$temp_output")"
	rm -f "$temp_output"
	printf "%s\n" "$current_version" $discovered_versions | awk '!seen[$0]++'
}

pick_php_version() {
	local current_version="$1"
	local discovered_versions
	if ! discovered_versions="$(discover_php_versions "$current_version")"; then
		echo -e "${ERROR} ${RED}Failed to discover PHP versions.${NC}"
		return 1
	fi
	printf "%s\n" $discovered_versions | fzf --border --highlight-line --height=10% --layout=reverse --header-lines=1 --prompt="Select PHP version > " || true
}

settings_view_current() {
	clear
	settings_ensure_file
	local settings_file
	settings_file="$(settings_file_path)"
	local configured_php_version
	local synced_php_version
	configured_php_version="$(settings_get_value "php_version" "php82")"
	if [[ -f "$CONF_DIR/php-version.conf" ]]; then
		synced_php_version="$(cat "$CONF_DIR/php-version.conf")"
	else
		synced_php_version="not-set"
	fi
	echo -e "${BLUE}${ROCKET} ${TITLE} Settings ${ROCKET}${NC}"
	echo
	echo -e "Settings File: $settings_file"
	echo -e "php_version (settings): $configured_php_version"
	echo -e "php_version (runtime): ${PHP_VERSION:-not-set}"
	echo -e "php-version.conf: $synced_php_version"
	read -n 1 -s -p "Press any key to continue..."
}

settings_change_php_version() {
	local selected_php_version
	selected_php_version="$(pick_php_version "${PHP_VERSION:-php82}")" || return 1
	[[ -z "$selected_php_version" ]] && return 0
	settings_set_value "php_version" "$selected_php_version"
	printf "%s\n" "$selected_php_version" > "$CONF_DIR/php-version.conf"
	PHP_VERSION="$selected_php_version"
	echo -e "${CHECK} ${GREEN}PHP version set in settings: $selected_php_version${NC}"
	install_php
	read -n 1 -s -p "Press any key to continue..."
}

settings_menu() {
	clear
	local settings_actions
	while true; do
		settings_actions=("View Current Settings" "Change PHP Version" "Back")
		local selected_settings_action
		selected_settings_action="$(printf "%s\n" "${settings_actions[@]}" | fzf --border --highlight-line --height=12% --layout=reverse --prompt="Settings > ")"
		[[ -z "$selected_settings_action" ]] && break
		case "$selected_settings_action" in
			"View Current Settings")
				settings_view_current ;;
			"Change PHP Version")
				settings_change_php_version ;;
			"Back")
				break ;;
		esac
	done
	clear
}

remove_dblock() {
	if [[ -f $INSTALL_DIR/.nix-portable/nix/var/nix/db/db.sqlite.lock ]]; then
		echo -e "\n${YELLOW}DB Lock Found Removing...${NC}"
		rm -rf "$INSTALL_DIR/.nix-portable/nix/var/nix/db/db.sqlite.lock"
		echo -e "${CHECK} ${GREEN}DB Lock removed${NC}"
	fi
}

setup_nix_portable() {
	echo -e "\n${BLUE}${ROCKET} Installing Nix-Portable ${ROCKET}${NC}"
	echo -e "${GEAR} ${YELLOW}Creating directory structure...${NC}"
	mkdir -p "$INSTALL_DIR/bin"
	mkdir -p "$WWW_DIR"
	mkdir -p "$CONF_DIR"
	mkdir -p "$INSTALL_DIR/apache"
	mkdir -p "$INSTALL_DIR/apache/logs"
	echo -e "${CHECK} ${GREEN}Directories created!${NC}"

	echo -e "\n${DOWNLOAD} ${YELLOW}Downloading nix-portable...${NC}"
	(
		curl -sL "https://github.com/DavHau/nix-portable/releases/latest/download/nix-portable-$(uname -m)" > "$INSTALL_DIR/bin/nix-portable"
	) &
	local download_pid=$!
	spinner "$download_pid"
	wait "$download_pid" || {
		echo -e "${ERROR} ${RED}Failed to download nix-portable.${NC}"
		return 1
	}
	chmod +x "$INSTALL_DIR/bin/nix-portable"
	echo -e "${CHECK} ${GREEN}Download complete!${NC}"
	echo -e "${SUCCESS} ${GREEN}Installation complete!${NC}"
}

install_apache() {
	if ! nix-portable nix path-info -f '<nixpkgs>' apacheHttpd.out >/dev/null 2>&1; then
		echo -e "${DOWNLOAD} ${YELLOW}Downloading Apache...${NC}"
		run_with_spinner nix-portable nix-shell -p apacheHttpd --run ""
		echo -e "${CHECK} ${GREEN}Download complete!${NC}"
	fi
}

install_php() {
	if ! nix-portable nix path-info -f '<nixpkgs>' "$PHP_VERSION" >/dev/null 2>&1; then
		echo -e "${DOWNLOAD} ${YELLOW}Downloading $PHP_VERSION...${NC}"
		run_with_spinner nix-portable nix-shell -p "$PHP_VERSION" --run ""
		echo -e "${CHECK} ${GREEN}Download complete!${NC}"

		echo "<?php phpinfo(); ?>" > "$WWW_DIR/index.php"
	fi
}

install_mysql() {
	if ! nix-portable nix path-info -f '<nixpkgs>' mysql.out >/dev/null 2>&1; then
		echo -e "${DOWNLOAD} ${YELLOW}Downloading MySQL...${NC}"
		run_with_spinner nix-portable nix-shell -p mysql --run ""
		echo -e "${CHECK} ${GREEN}Download complete!${NC}"
	fi
}

install_mailhog() {
	if ! nix-portable nix path-info -f '<nixpkgs>' mailhog >/dev/null 2>&1; then
		echo -e "${DOWNLOAD} ${YELLOW}Downloading MailHog...${NC}"
		run_with_spinner nix-portable nix-shell -p mailhog --run ""
		echo -e "${CHECK} ${GREEN}Download complete!${NC}"
	fi
}

config_mailhog() {
	echo -e "${YELLOW}Setting up MailHog...${NC}"
	
	if [[ ! -d $INSTALL_DIR/mailhog ]]; then
		mkdir -p "$INSTALL_DIR/mailhog"
		echo -e "${CHECK} ${GREEN}MailHog directory created!${NC}"
	fi
	
	if [[ ! -f $INSTALL_DIR/mailhog/mailhog.log ]]; then
		touch "$INSTALL_DIR/mailhog/mailhog.log"
		echo -e "${CHECK} ${GREEN}MailHog log file created!${NC}"
	fi
	
	echo -e "${SUCCESS} ${GREEN}MailHog configuration complete!${NC}"
	echo -e "${BLUE}SMTP Server: localhost:1025${NC}"
	echo -e "${BLUE}Web UI: http://localhost:8025${NC}"
	mailhog_users_init || true
}

trim_value() {
	local value="$1"
	value="${value#"${value%%[![:space:]]*}"}"
	value="${value%"${value##*[![:space:]]}"}"
	printf "%s" "$value"
}

mailhog_users_file_path() {
	echo "$INSTALL_DIR/mailhog/users.json"
}

mailhog_users_init() {
	local users_file
	users_file="$(mailhog_users_file_path)"
	mkdir -p "$INSTALL_DIR/mailhog"
	if [[ ! -f "$users_file" ]]; then
		printf '{ "users": [] }\n' > "$users_file"
	fi
	if ! jq -e '.users and (.users | type == "array")' "$users_file" >/dev/null 2>&1; then
		echo -e "${ERROR} ${RED}Invalid MailHog users data: $users_file${NC}"
		echo -e "${YELLOW}Fix JSON format to continue CRUD and test-email actions.${NC}"
		return 1
	fi
	return 0
}

mailhog_email_valid() {
	local email="$1"
	[[ "$email" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]
}

mailhog_tags_to_json() {
	local tags_input="$1"
	jq -cn --arg tags_input "$tags_input" '$tags_input | split(",") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length > 0)) | unique'
}

mailhog_generate_user_id() {
	local users_file
	users_file="$(mailhog_users_file_path)"
	local candidate_id
	while true; do
		candidate_id="$(date +%Y%m%d%H%M%S)-$RANDOM"
		if ! jq -e --arg candidate_id "$candidate_id" '.users | any(.id == $candidate_id)' "$users_file" >/dev/null 2>&1; then
			echo "$candidate_id"
			return 0
		fi
	done
}

mailhog_user_pick_id() {
	local role_filter="${1:-}"
	local users_file
	users_file="$(mailhog_users_file_path)"
	local selection
	selection="$(jq -r --arg role_filter "$role_filter" '
		.users[]
		| select($role_filter == "" or .role == $role_filter)
		| [.id, .name, .email, .role, ((.tags // []) | join(","))]
		| @tsv
	' "$users_file" | fzf --border --highlight-line --height=45% --layout=reverse --prompt="Mail users > " || true)"
	[[ -z "$selection" ]] && return 1
	printf "%s" "$selection" | awk -F '\t' '{print $1}'
}

mailhog_user_pick_by_role() {
	local required_role="$1"
	mailhog_user_pick_id "$required_role"
}

mailhog_users_list() {
	if ! mailhog_users_init; then
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	local users_file
	users_file="$(mailhog_users_file_path)"
	if ! jq -e '.users | length > 0' "$users_file" >/dev/null 2>&1; then
		echo -e "${YELLOW}No MailHog users found.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 0
	fi
	echo -e "${BLUE}ID\tNAME\tEMAIL\tROLE\tTAGS${NC}"
	jq -r '.users[] | [.id, .name, .email, .role, ((.tags // []) | join(","))] | @tsv' "$users_file"
	read -n 1 -s -p "Press any key to continue..."
}

mailhog_user_create() {
	if ! mailhog_users_init; then
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	local users_file
	users_file="$(mailhog_users_file_path)"
	local user_name
	local user_email
	local user_role
	local user_tags_input
	local user_tags_json
	local user_id
	read -r -p "Name: " user_name
	user_name="$(trim_value "$user_name")"
	if [[ -z "$user_name" ]]; then
		echo -e "${ERROR} ${RED}Name is required.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	read -r -p "Email: " user_email
	user_email="$(trim_value "${user_email,,}")"
	if [[ -z "$user_email" ]] || ! mailhog_email_valid "$user_email"; then
		echo -e "${ERROR} ${RED}Valid email is required.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	if jq -e --arg user_email "$user_email" '.users | any(.email == $user_email)' "$users_file" >/dev/null 2>&1; then
		echo -e "${ERROR} ${RED}Email already exists.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	read -r -p "Role (sender/receiver): " user_role
	user_role="$(trim_value "${user_role,,}")"
	if [[ "$user_role" != "sender" && "$user_role" != "receiver" ]]; then
		echo -e "${ERROR} ${RED}Role must be sender or receiver.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	read -r -p "Tags (comma-separated): " user_tags_input
	user_tags_json="$(mailhog_tags_to_json "$user_tags_input")"
	user_id="$(mailhog_generate_user_id)"
	local temp_file
	temp_file="$(mktemp)"
	if ! jq --arg user_id "$user_id" --arg user_name "$user_name" --arg user_email "$user_email" --arg user_role "$user_role" --argjson user_tags "$user_tags_json" '
		.users += [{
			"id": $user_id,
			"name": $user_name,
			"email": $user_email,
			"role": $user_role,
			"tags": $user_tags
		}]
	' "$users_file" > "$temp_file"; then
		rm -f "$temp_file"
		echo -e "${ERROR} ${RED}Failed to create user.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	mv "$temp_file" "$users_file"
	echo -e "${CHECK} ${GREEN}User created: $user_name <$user_email>${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

mailhog_user_view() {
	if ! mailhog_users_init; then
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	local users_file
	users_file="$(mailhog_users_file_path)"
	local selected_id
	selected_id="$(mailhog_user_pick_id)" || return 0
	jq --arg selected_id "$selected_id" '.users[] | select(.id == $selected_id)' "$users_file"
	read -n 1 -s -p "Press any key to continue..."
}

mailhog_user_update() {
	if ! mailhog_users_init; then
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	local users_file
	users_file="$(mailhog_users_file_path)"
	local selected_id
	selected_id="$(mailhog_user_pick_id)" || return 0
	local current_name
	local current_email
	local current_role
	local current_tags
	current_name="$(jq -r --arg selected_id "$selected_id" '.users[] | select(.id == $selected_id) | .name' "$users_file")"
	current_email="$(jq -r --arg selected_id "$selected_id" '.users[] | select(.id == $selected_id) | .email' "$users_file")"
	current_role="$(jq -r --arg selected_id "$selected_id" '.users[] | select(.id == $selected_id) | .role' "$users_file")"
	current_tags="$(jq -r --arg selected_id "$selected_id" '.users[] | select(.id == $selected_id) | ((.tags // []) | join(","))' "$users_file")"
	local updated_name
	local updated_email
	local updated_role
	local updated_tags_input
	read -r -p "Name [$current_name]: " updated_name
	updated_name="$(trim_value "$updated_name")"
	[[ -z "$updated_name" ]] && updated_name="$current_name"
	read -r -p "Email [$current_email]: " updated_email
	updated_email="$(trim_value "${updated_email,,}")"
	[[ -z "$updated_email" ]] && updated_email="$current_email"
	if ! mailhog_email_valid "$updated_email"; then
		echo -e "${ERROR} ${RED}Valid email is required.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	if jq -e --arg selected_id "$selected_id" --arg updated_email "$updated_email" '.users | any(.id != $selected_id and .email == $updated_email)' "$users_file" >/dev/null 2>&1; then
		echo -e "${ERROR} ${RED}Email already exists.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	read -r -p "Role (sender/receiver) [$current_role]: " updated_role
	updated_role="$(trim_value "${updated_role,,}")"
	[[ -z "$updated_role" ]] && updated_role="$current_role"
	if [[ "$updated_role" != "sender" && "$updated_role" != "receiver" ]]; then
		echo -e "${ERROR} ${RED}Role must be sender or receiver.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	read -r -p "Tags comma-separated [$current_tags] (NONE to clear): " updated_tags_input
	local updated_tags_json
	if [[ "$(trim_value "${updated_tags_input^^}")" == "NONE" ]]; then
		updated_tags_json='[]'
	elif [[ -z "$(trim_value "$updated_tags_input")" ]]; then
		updated_tags_json="$(mailhog_tags_to_json "$current_tags")"
	else
		updated_tags_json="$(mailhog_tags_to_json "$updated_tags_input")"
	fi
	local temp_file
	temp_file="$(mktemp)"
	if ! jq --arg selected_id "$selected_id" --arg updated_name "$updated_name" --arg updated_email "$updated_email" --arg updated_role "$updated_role" --argjson updated_tags "$updated_tags_json" '
		.users |= map(if .id == $selected_id then . + {
			"name": $updated_name,
			"email": $updated_email,
			"role": $updated_role,
			"tags": $updated_tags
		} else . end)
	' "$users_file" > "$temp_file"; then
		rm -f "$temp_file"
		echo -e "${ERROR} ${RED}Failed to update user.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	mv "$temp_file" "$users_file"
	echo -e "${CHECK} ${GREEN}User updated.${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

mailhog_user_delete() {
	if ! mailhog_users_init; then
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	local users_file
	users_file="$(mailhog_users_file_path)"
	local selected_id
	selected_id="$(mailhog_user_pick_id)" || return 0
	local selected_email
	selected_email="$(jq -r --arg selected_id "$selected_id" '.users[] | select(.id == $selected_id) | .email' "$users_file")"
	local delete_token
	echo -e "${YELLOW}Type DELETE to permanently remove user: $selected_email${NC}"
	read -r delete_token
	if [[ "$delete_token" != "DELETE" ]]; then
		echo -e "${YELLOW}Delete cancelled.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 0
	fi
	local temp_file
	temp_file="$(mktemp)"
	if ! jq --arg selected_id "$selected_id" '.users |= map(select(.id != $selected_id))' "$users_file" > "$temp_file"; then
		rm -f "$temp_file"
		echo -e "${ERROR} ${RED}Failed to delete user.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	mv "$temp_file" "$users_file"
	echo -e "${CHECK} ${GREEN}User deleted.${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

setup_mailhog() {
	echo -e "${YELLOW}Installing MailHog ${NC}"
	install_mailhog
	config_mailhog
}

start_mailhog() {
	config_mailhog
	
	if is_running "MailHog"; then
		echo -e "${YELLOW}MailHog is already running!${NC}"
		return 0
	fi
	
	echo -e "${YELLOW}Starting MailHog...${NC}"
	nix-portable nix-shell -p mailhog --run "
		MailHog > $INSTALL_DIR/mailhog/mailhog.log 2>&1 &
	"
	if ! wait_until_running "MailHog" 20 0.25; then
		echo -e "${ERROR} ${RED}MailHog failed to start.${NC}"
		return 1
	fi
	echo -e "${CHECK} ${GREEN}MailHog started!${NC}"
	echo -e "${BLUE}SMTP Server: localhost:1025${NC}"
	echo -e "${BLUE}Web UI: http://localhost:8025${NC}"
	clear
}

stop_mailhog() {
	echo -e "${YELLOW}Stopping MailHog...${NC}"
	
	if is_running "MailHog"; then
		pkill -f "MailHog" 2>/dev/null || true
		if ! wait_until_stopped "MailHog" 20 0.25; then
			echo -e "${ERROR} ${RED}MailHog did not stop cleanly.${NC}"
			return 1
		fi
	fi
	
	echo -e "${CHECK} ${GREEN}MailHog stopped!${NC}"
	clear
}

restart_mailhog() {
	stop_mailhog
	sleep 1
	start_mailhog
}

config_php_mail() {
	echo -e "${YELLOW}Configuring PHP to use MailHog...${NC}"
	
	cat > "$CONF_DIR/php-mail.ini" <<EOF
[mail function]
sendmail_path = "/usr/bin/env catchmail -smtp-addr localhost:1025"
SMTP = localhost
smtp_port = 1025
EOF
	
	echo -e "${CHECK} ${GREEN}PHP mail configuration created!${NC}"
	echo -e "${YELLOW}Note: Restart PHP-FPM for changes to take effect.${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

open_mailhog_ui() {
	if ! is_running "MailHog"; then
		echo -e "${ERROR} ${RED}MailHog is not running! Please start MailHog first.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	
	echo -e "${BLUE}Opening MailHog Web UI...${NC}"
	echo -e "${GREEN}URL: http://localhost:8025${NC}"
	
	if command -v xdg-open &> /dev/null; then
		xdg-open "http://localhost:8025" 2>/dev/null &
	elif command -v open &> /dev/null; then
		open "http://localhost:8025" 2>/dev/null &
	else
		echo -e "${YELLOW}Please open http://localhost:8025 in your browser.${NC}"
	fi
	read -n 1 -s -p "Press any key to continue..."
}

test_email() {
	if ! is_running "MailHog"; then
		echo -e "${ERROR} ${RED}MailHog is not running! Please start MailHog first.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	if ! mailhog_users_init; then
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	local users_file
	users_file="$(mailhog_users_file_path)"
	if ! jq -e '.users | any(.role == "sender")' "$users_file" >/dev/null 2>&1; then
		echo -e "${ERROR} ${RED}No sender users found. Create at least one sender user first.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	if ! jq -e '.users | any(.role == "receiver")' "$users_file" >/dev/null 2>&1; then
		echo -e "${ERROR} ${RED}No receiver users found. Create at least one receiver user first.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	echo -e "${YELLOW}Select sender user...${NC}"
	local sender_user_id
	sender_user_id="$(mailhog_user_pick_by_role "sender")" || return 0
	echo -e "${YELLOW}Select receiver user...${NC}"
	local receiver_user_id
	receiver_user_id="$(mailhog_user_pick_by_role "receiver")" || return 0
	local sender_user_email
	local sender_user_name
	local receiver_user_email
	local receiver_user_name
	sender_user_email="$(jq -r --arg sender_user_id "$sender_user_id" '.users[] | select(.id == $sender_user_id) | .email' "$users_file")"
	sender_user_name="$(jq -r --arg sender_user_id "$sender_user_id" '.users[] | select(.id == $sender_user_id) | .name' "$users_file")"
	receiver_user_email="$(jq -r --arg receiver_user_id "$receiver_user_id" '.users[] | select(.id == $receiver_user_id) | .email' "$users_file")"
	receiver_user_name="$(jq -r --arg receiver_user_id "$receiver_user_id" '.users[] | select(.id == $receiver_user_id) | .name' "$users_file")"
	if [[ -z "$sender_user_email" || -z "$receiver_user_email" ]]; then
		echo -e "${ERROR} ${RED}Failed to resolve sender or receiver user.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	
	echo -e "${YELLOW}Sending test email...${NC}"
	
	echo -e "Subject: Test Email from ApacheNest\nFrom: $sender_user_name <$sender_user_email>\nTo: $receiver_user_name <$receiver_user_email>\n\nThis is a test email from ApacheNest MailHog.\nIf you see this in MailHog UI, email is working!" | \
	nix-portable nix-shell -p mailhog --run "MailHog sendmail" 2>/dev/null || \
	(
		{
			echo "EHLO localhost"
			sleep 0.2
			echo "MAIL FROM:<$sender_user_email>"
			sleep 0.2
			echo "RCPT TO:<$receiver_user_email>"
			sleep 0.2
			echo "DATA"
			sleep 0.2
			echo "Subject: Test Email from ApacheNest"
			echo "From: $sender_user_name <$sender_user_email>"
			echo "To: $receiver_user_name <$receiver_user_email>"
			echo ""
			echo "This is a test email from ApacheNest MailHog."
			echo "If you see this in MailHog UI, email is working!"
			echo "."
			sleep 0.2
			echo "QUIT"
		} | nc localhost 1025 2>/dev/null
	)
	
	echo -e "${SUCCESS} ${GREEN}Test email sent from $sender_user_email to $receiver_user_email. Check MailHog UI at http://localhost:8025${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

config_mysql() {
	echo -e "${YELLOW}Setting up MySQL...${NC}"
	
	if [[ ! -d $INSTALL_DIR/mysql ]]; then
		mkdir -p "$INSTALL_DIR/mysql"
		echo -e "${CHECK} ${GREEN}MySQL directory created!${NC}"
	fi
	
	if [[ ! -d $INSTALL_DIR/mysql/data ]]; then
		mkdir -p "$INSTALL_DIR/mysql/data"
		echo -e "${CHECK} ${GREEN}MySQL data directory created!${NC}"
	fi
	
	if [[ ! -f $INSTALL_DIR/mysql/my.cnf ]]; then
		echo -e "${YELLOW}Creating MySQL config...${NC}"
		cat > "$INSTALL_DIR/mysql/my.cnf" <<EOF
[mysqld]
datadir = $INSTALL_DIR/mysql/data
socket = $INSTALL_DIR/mysql/mysql.sock
user = $(whoami)
bind-address = 127.0.0.1
port = 3306
skip-external-locking
default_storage_engine = InnoDB
innodb_file_per_table = 1
innodb_log_file_size = 64M
log-error = $INSTALL_DIR/mysql/mysql.log
pid-file = $INSTALL_DIR/mysql/mysql.pid
tmpdir = $INSTALL_DIR/mysql

[mysqld_safe]
log-error = $INSTALL_DIR/mysql/mysql.log
pid-file = $INSTALL_DIR/mysql/mysql.pid

[mysql]
socket = $INSTALL_DIR/mysql/mysql.sock

[client]
socket = $INSTALL_DIR/mysql/mysql.sock
EOF
		echo -e "${CHECK} ${GREEN}MySQL config created!${NC}"
	fi

	if [[ ! -f $INSTALL_DIR/mysql/mysql.log ]]; then
		touch "$INSTALL_DIR/mysql/mysql.log"
		echo -e "${CHECK} ${GREEN}MySQL log file created!${NC}"
	fi

	if [[ ! -f $INSTALL_DIR/mysql/mysql.pid ]]; then
		touch "$INSTALL_DIR/mysql/mysql.pid"
		echo -e "${CHECK} ${GREEN}MySQL PID file created!${NC}"
	fi
	
	echo -e "${SUCCESS} ${GREEN}MySQL configuration complete!${NC}"
}

mysql_root_password_file_path() {
	echo "$CONF_DIR/mysql-root-password.conf"
}

mysql_save_root_password() {
	local root_password="$1"
	local password_file
	password_file="$(mysql_root_password_file_path)"
	mkdir -p "$CONF_DIR"
	(
		umask 077
		printf "%s\n" "$root_password" > "$password_file"
	)
	chmod 600 "$password_file"
}

mysql_load_root_password() {
	local password_file
	password_file="$(mysql_root_password_file_path)"
	[[ -f "$password_file" ]] || return 1
	local stored_password
	stored_password="$(<"$password_file")"
	[[ -n "$stored_password" ]] || return 1
	printf "%s" "$stored_password"
}

mysql_prompt_new_root_password() {
	local first_password
	local second_password
	echo -e "${BLUE}Enter new MySQL root password:${NC}" >&2
	read -s first_password
	echo >&2
	if [[ -z "$first_password" ]]; then
		echo -e "${ERROR} ${RED}Password cannot be empty.${NC}" >&2
		return 1
	fi
	echo -e "${BLUE}Confirm new MySQL root password:${NC}" >&2
	read -s second_password
	echo >&2
	if [[ "$first_password" != "$second_password" ]]; then
		echo -e "${ERROR} ${RED}Passwords do not match.${NC}" >&2
		return 1
	fi
	printf "%s" "$first_password"
}

mysql_verify_root_password() {
	local root_password="$1"
	local escaped_password
	printf -v escaped_password '%q' "$root_password"
	nix-portable nix-shell -p mysql --run "MYSQL_PWD=$escaped_password mysqladmin --socket=$INSTALL_DIR/mysql/mysql.sock -u root ping >/dev/null 2>&1"
}

mysql_require_stored_or_prompt_existing_password() {
	local stored_password
	if stored_password="$(mysql_load_root_password)"; then
		printf "%s" "$stored_password"
		return 0
	fi
	echo -e "${YELLOW}MySQL root password is not stored yet.${NC}" >&2
	echo -e "${BLUE}Enter current MySQL root password:${NC}" >&2
	read -s stored_password
	echo >&2
	if [[ -z "$stored_password" ]]; then
		echo -e "${ERROR} ${RED}Password cannot be empty.${NC}" >&2
		return 1
	fi
	if ! mysql_verify_root_password "$stored_password"; then
		echo -e "${ERROR} ${RED}Failed to verify MySQL root password.${NC}" >&2
		return 1
	fi
	mysql_save_root_password "$stored_password"
	echo -e "${CHECK} ${GREEN}MySQL root password saved.${NC}" >&2
	printf "%s" "$stored_password"
}

mysql_escape_sql_literal() {
	local sql_value="$1"
	sql_value="${sql_value//\'/\'\'}"
	printf "%s" "$sql_value"
}

set_mysql_initial_password() {
	local root_password="${1:-}"
	if [[ -z "$root_password" ]]; then
		echo -e "${ERROR} ${RED}MySQL root password is required.${NC}"
		return 1
	fi
	echo -e "${YELLOW}Setting initial MySQL root password...${NC}"
	local escaped_password
	printf -v escaped_password '%q' "$root_password"
	nix-portable nix-shell -p mysql --run "
		mysqladmin --socket=$INSTALL_DIR/mysql/mysql.sock -u root password $escaped_password
	" 2>/dev/null
	echo -e "${CHECK} ${GREEN}MySQL root password configured.${NC}"
}

mysql_change_password() {
	echo -e "${YELLOW}Change MySQL Root Password${NC}"
	
	if ! is_running "mysqld"; then
		echo -e "${ERROR} ${RED}MySQL server is not running! Please start MySQL first.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	local current_password
	if ! current_password="$(mysql_require_stored_or_prompt_existing_password)"; then
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	local new_password
	if ! new_password="$(mysql_prompt_new_root_password)"; then
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	local escaped_current_password
	local escaped_new_password
	printf -v escaped_current_password '%q' "$current_password"
	printf -v escaped_new_password '%q' "$new_password"
	echo -e "${YELLOW}Changing password...${NC}"
	if nix-portable nix-shell -p mysql --run "
		MYSQL_PWD=$escaped_current_password mysqladmin --socket=$INSTALL_DIR/mysql/mysql.sock -u root password $escaped_new_password
	" 2>/dev/null; then
		mysql_save_root_password "$new_password"
		echo -e "${SUCCESS} ${GREEN}Password changed successfully!${NC}"
	else
		echo -e "${ERROR} ${RED}Failed to change password. Check your current password.${NC}"
	fi
	read -n 1 -s -p "Press any key to continue..."
}

mysql_reset_password() {
	echo -e "${YELLOW}Reset MySQL Root Password${NC}"
	echo -e "${RED}WARNING: This will stop MySQL, reset the root password, and restart MySQL.${NC}"
	echo
	echo -e "${YELLOW}Do you want to continue? (y/n)${NC}"
	read -n 1 -r
	echo
	
	if [[ ! $REPLY =~ ^[Yy]$ ]]; then
		echo -e "${YELLOW}Password reset cancelled.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 0
	fi
	if is_running "mysqld" && [[ ! -f "$(mysql_root_password_file_path)" ]]; then
		mysql_require_stored_or_prompt_existing_password >/dev/null 2>&1 || true
	fi
	local reset_password
	if ! reset_password="$(mysql_prompt_new_root_password)"; then
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	echo -e "${YELLOW}Stopping MySQL...${NC}"
	stop_mysql 2>/dev/null
	
	echo -e "${YELLOW}Starting MySQL in skip-grant-tables mode...${NC}"
	nix-portable nix-shell -p mysql --run "
		mysqld_safe --defaults-file=$INSTALL_DIR/mysql/my.cnf --skip-grant-tables &
	" > /dev/null 2>&1 &
	sleep 3
	
	echo -e "${YELLOW}Resetting root password...${NC}"
	local escaped_reset_password_sql
	escaped_reset_password_sql="$(mysql_escape_sql_literal "$reset_password")"
	if ! nix-portable nix-shell -p mysql --run "
		mysql --socket=$INSTALL_DIR/mysql/mysql.sock -u root <<-EOSQL
			FLUSH PRIVILEGES;
			ALTER USER 'root'@'localhost' IDENTIFIED BY '$escaped_reset_password_sql';
			FLUSH PRIVILEGES;
		EOSQL
	" 2>/dev/null; then
		echo -e "${ERROR} ${RED}Failed to reset MySQL root password.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	echo -e "${YELLOW}Restarting MySQL normally...${NC}"
	stop_mysql 2>/dev/null
	sleep 2
	if ! start_mysql 2>/dev/null; then
		echo -e "${ERROR} ${RED}Failed to restart MySQL after password reset.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	mysql_save_root_password "$reset_password"
	echo -e "${SUCCESS} ${GREEN}Password reset completed.${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

mysql_reset_data() {
	echo -e "${RED}WARNING: Reset MySQL Database Data${NC}"
	echo -e "${RED}This will DELETE ALL MySQL data and reinitialize the database!${NC}"
	echo -e "${RED}All databases, tables, and data will be permanently lost!${NC}"
	echo
	echo -e "${YELLOW}Type 'RESET' to confirm:${NC}"
	read CONFIRM
	
	if [[ "$CONFIRM" != "RESET" ]]; then
		echo -e "${YELLOW}Reset cancelled.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 0
	fi
	
	echo -e "${YELLOW}Stopping MySQL...${NC}"
	stop_mysql 2>/dev/null
	sleep 2
	
	echo -e "${YELLOW}Removing MySQL data directory...${NC}"
	rm -rf "$INSTALL_DIR/mysql/data"
	mkdir -p "$INSTALL_DIR/mysql/data"
	echo -e "${CHECK} ${GREEN}Data directory cleared!${NC}"
	
	echo -e "${YELLOW}Reinitializing MySQL database...${NC}"
	nix-portable nix-shell -p mysql --run "
		mysql_install_db --defaults-file=$INSTALL_DIR/mysql/my.cnf --datadir=$INSTALL_DIR/mysql/data --user=\$(whoami)
	" 2>/dev/null
	echo -e "${CHECK} ${GREEN}MySQL database reinitialized!${NC}"
	
	echo -e "${YELLOW}Starting MySQL...${NC}"
	nix-portable nix-shell -p mysql --run "
		mysqld_safe --defaults-file=$INSTALL_DIR/mysql/my.cnf &
	" > /dev/null 2>&1 &
	sleep 3
	local new_root_password
	if ! new_root_password="$(mysql_prompt_new_root_password)"; then
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	if ! set_mysql_initial_password "$new_root_password"; then
		echo -e "${ERROR} ${RED}Failed to set MySQL root password after reset.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	mysql_save_root_password "$new_root_password"
	echo -e "${SUCCESS} ${GREEN}MySQL data reset complete.${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

setup_apache_php() {
	settings_ensure_file
	local configured_php_version
	configured_php_version="$(settings_get_value "php_version" "php82")"
	printf "%s\n" "$configured_php_version" > "$CONF_DIR/php-version.conf"
	PHP_VERSION="$configured_php_version"
	install_apache
	install_php
}

resolve_apache_path() {
	nix-portable nix-shell -p apacheHttpd --run "echo \$(dirname \$(dirname \$(command -v httpd)))" 2>/dev/null
}

ensure_default_htaccess() {
	local htaccess_file="$WWW_DIR/.htaccess"
	mkdir -p "$WWW_DIR"
	if [[ -f "$htaccess_file" ]]; then
		return 0
	fi
	cat > "$htaccess_file" <<'EOF'
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]
RewriteRule ^ index.php [L]
EOF
	echo -e "${CHECK} ${GREEN}Default .htaccess created.${NC}"
}

ensure_rewrite_in_httpd_config() {
	local httpd_file="$CONF_DIR/httpd.conf"
	if [[ ! -f "$httpd_file" ]]; then
		return 0
	fi
	local apache_path
	apache_path="$(resolve_apache_path)"
	if [[ -z "$apache_path" ]]; then
		echo -e "${ERROR} ${RED}Unable to resolve Apache path for rewrite support.${NC}"
		return 1
	fi
	local rewrite_module_line
	rewrite_module_line="LoadModule rewrite_module $apache_path/modules/mod_rewrite.so"
	local dir_open_line
	dir_open_line="<Directory \"$WWW_DIR\">"
	local temp_file
	temp_file="$(mktemp)"
	awk -v rewrite_line="$rewrite_module_line" -v dir_open="$dir_open_line" '
	{
		lines[++line_count] = $0
		if ($0 ~ /^LoadModule rewrite_module[[:space:]]+/) {
			has_rewrite = 1
		}
		if ($0 ~ /^LoadModule[[:space:]]+/) {
			last_load_module = line_count
		}
		if ($0 ~ /^[[:space:]]*AllowOverride[[:space:]]+/) {
			has_allow_override_any = 1
		}
		if ($0 == dir_open) {
			in_target_directory = 1
			target_directory_found = 1
			target_directory_line = line_count
			target_directory_has_allow_override = 0
			next
		}
		if (in_target_directory == 1) {
			if ($0 ~ /^[[:space:]]*AllowOverride[[:space:]]+/) {
				target_directory_has_allow_override = 1
			}
			if ($0 ~ /^[[:space:]]*<\/Directory>/) {
				in_target_directory = 0
				if (target_directory_has_allow_override == 0) {
					needs_allow_override = 1
				}
			}
		}
	}
	END {
		if (has_rewrite == 0) {
			needs_rewrite = 1
		}
		if (target_directory_found == 0 && has_allow_override_any == 0) {
			needs_allow_override = 0
		}
		rewrite_inserted = 0
		for (i = 1; i <= line_count; i++) {
			print lines[i]
			if (needs_rewrite == 1 && rewrite_inserted == 0 && i == last_load_module) {
				print rewrite_line
				rewrite_inserted = 1
			}
			if (needs_allow_override == 1 && i == target_directory_line) {
				print "    AllowOverride All"
			}
		}
		if (needs_rewrite == 1 && rewrite_inserted == 0) {
			print rewrite_line
		}
	}
	' "$httpd_file" > "$temp_file" || {
		rm -f "$temp_file"
		echo -e "${ERROR} ${RED}Failed to patch Apache rewrite configuration.${NC}"
		return 1
	}
	if ! grep -q "^LoadModule rewrite_module " "$temp_file"; then
		rm -f "$temp_file"
		echo -e "${ERROR} ${RED}Apache rewrite module directive validation failed.${NC}"
		return 1
	fi
	if awk -v dir_open="$dir_open_line" '
	$0 == dir_open { in_target = 1; next }
	in_target == 1 && /^[[:space:]]*AllowOverride[[:space:]]+All$/ { has_allow = 1 }
	in_target == 1 && /^[[:space:]]*<\/Directory>/ { exit }
	END { if (in_target == 1 && has_allow == 1) exit 0; exit 1 }
	' "$temp_file"; then
		:
	else
		if grep -q "AllowOverride" "$temp_file"; then
			:
		else
			rm -f "$temp_file"
			echo -e "${ERROR} ${RED}Apache AllowOverride validation failed.${NC}"
			return 1
		fi
	fi
	if cmp -s "$httpd_file" "$temp_file"; then
		rm -f "$temp_file"
		return 0
	fi
	mv "$temp_file" "$httpd_file"
	echo -e "${CHECK} ${GREEN}Apache rewrite support updated in httpd.conf.${NC}"
	return 0
}

ensure_rewrite_support() {
	ensure_rewrite_in_httpd_config
	ensure_default_htaccess
}

setup_configs() {
	APACHE_PATH="$(resolve_apache_path)"
	echo -e "\n${GEAR} ${YELLOW}Setting up ApacheNest configs...${NC}"
	
	echo -e "${YELLOW}Creating PHP-FPM config...${NC}"
	cat > "$CONF_DIR/php-fpm.conf" <<EOF
[global]
error_log = $INSTALL_DIR/php-fpm.log

[www]
listen = 127.0.0.1:9000
listen.allowed_clients = 127.0.0.1
pm = dynamic
pm.max_children = 5
pm.start_servers = 2
pm.min_spare_servers = 1
pm.max_spare_servers = 3
chdir = /
EOF

	echo -e "${YELLOW}Creating Apache config...${NC}"
	cat > "$CONF_DIR/httpd.conf" <<EOF
ServerName 127.0.0.1
ServerRoot "$INSTALL_DIR/apache"
Listen 8080
LoadModule mpm_event_module $APACHE_PATH/modules/mod_mpm_event.so
LoadModule proxy_module $APACHE_PATH/modules/mod_proxy.so
LoadModule proxy_fcgi_module $APACHE_PATH/modules/mod_proxy_fcgi.so
LoadModule dir_module $APACHE_PATH/modules/mod_dir.so
LoadModule mime_module $APACHE_PATH/modules/mod_mime.so
LoadModule authz_core_module $APACHE_PATH/modules/mod_authz_core.so
LoadModule unixd_module $APACHE_PATH/modules/mod_unixd.so
LoadModule rewrite_module $APACHE_PATH/modules/mod_rewrite.so

DocumentRoot "$WWW_DIR"
<Directory "$WWW_DIR">
		AllowOverride All
		Require all granted
</Directory>

DirectoryIndex index.php index.html

<FilesMatch \.php$>
		SetHandler "proxy:fcgi://127.0.0.1:9000"
</FilesMatch>

TypesConfig $APACHE_PATH/conf/mime.types
EOF
	ensure_default_htaccess
	echo -e "${SUCCESS} ${GREEN}ApacheNest config ready!${NC}\n"
}

setup_mysql() {
	echo -e "${YELLOW}Installing MySQL ${NC}"
	install_mysql
	config_mysql
}

setup_apachenest(){
	setup_nix_portable
	setup_apache_php
	setup_configs

	setup_mysql
	setup_mailhog
}

select_php() {
	stop_php
	local current_version="$PHP_VERSION"
	[[ -f $CONF_DIR/php-version.conf ]] && current_version="$(<"$CONF_DIR/php-version.conf")"
	local selected_version
	selected_version="$(pick_php_version "$current_version")" || return 1
	local SELECTED_VERSION="$selected_version"
	[[ -z $SELECTED_VERSION ]] && return
	PHP_VERSION=$SELECTED_VERSION
	echo "$SELECTED_VERSION" > $CONF_DIR/php-version.conf
	settings_set_value "php_version" "$SELECTED_VERSION"
	echo -e "${CHECK} ${GREEN}PHP version selected!${NC}"
	install_php
}

php_info() {
	echo -e "${BLUE}=== PHP Information ===${NC}\n"
	echo -e "${YELLOW}Current Version:${NC} $PHP_VERSION"
	echo
	
	nix-portable nix-shell -p $PHP_VERSION --run "
		echo -e '${YELLOW}PHP Version Details:${NC}'
		php -v
		echo
		echo -e '${YELLOW}PHP Binary Path:${NC}'
		command -v php
		echo
		echo -e '${YELLOW}PHP-FPM Binary Path:${NC}'
		command -v php-fpm
		echo
		echo -e '${YELLOW}PHP Configuration File:${NC}'
		php --ini | head -5
	" 2>/dev/null
	
	echo
	read -n 1 -s -p "Press any key to continue..."
}

php_extensions() {
	echo -e "${BLUE}=== PHP Extensions ===${NC}\n"
	echo -e "${YELLOW}Installed extensions for $PHP_VERSION:${NC}\n"
	
	nix-portable nix-shell -p $PHP_VERSION --run "
		php -m
	" 2>/dev/null | column
	
	echo
	read -n 1 -s -p "Press any key to continue..."
}

php_phpinfo() {
	echo -e "${YELLOW}Creating phpinfo page...${NC}"
	
	echo '<?php phpinfo(); ?>' > "$WWW_DIR/phpinfo.php"
	echo -e "${CHECK} ${GREEN}phpinfo.php created in $WWW_DIR${NC}"
	
	if ! is_running "$CONF_DIR/httpd.conf" || ! is_running "$CONF_DIR/php-fpm.conf"; then
		echo -e "${YELLOW}Apache or PHP-FPM is not running.${NC}"
		echo -e "${YELLOW}Start both services to view phpinfo in browser.${NC}"
	else
		echo -e "${BLUE}Opening phpinfo in browser...${NC}"
		echo -e "${GREEN}URL: http://localhost:8080/phpinfo.php${NC}"
		
		if command -v xdg-open &> /dev/null; then
			xdg-open "http://localhost:8080/phpinfo.php" 2>/dev/null &
		elif command -v open &> /dev/null; then
			open "http://localhost:8080/phpinfo.php" 2>/dev/null &
		fi
	fi
	
	read -n 1 -s -p "Press any key to continue..."
}

php_edit_config() {
	echo -e "${BLUE}=== PHP Configuration ===${NC}\n"
	
	if [[ ! -f $CONF_DIR/php.ini ]]; then
		echo -e "${YELLOW}Creating custom php.ini...${NC}"
		cat > "$CONF_DIR/php.ini" <<EOF
; ApacheNest Custom PHP Configuration
; Add your PHP settings here

[PHP]
; Maximum execution time of each script, in seconds
max_execution_time = 300

; Maximum amount of memory a script may consume
memory_limit = 256M

; Maximum size of POST data that PHP will accept
post_max_size = 64M

; Maximum allowed size for uploaded files
upload_max_filesize = 64M

; Maximum number of files that can be uploaded via a single request
max_file_uploads = 20

; Default timezone
date.timezone = UTC

; Error reporting
error_reporting = E_ALL
display_errors = On
display_startup_errors = On
log_errors = On
error_log = $INSTALL_DIR/php-error.log

[opcache]
opcache.enable = 1
opcache.memory_consumption = 128
opcache.interned_strings_buffer = 8
opcache.max_accelerated_files = 10000
opcache.validate_timestamps = 1
opcache.revalidate_freq = 2

[Session]
session.save_path = $INSTALL_DIR/sessions

[mail function]
; For MailHog
SMTP = localhost
smtp_port = 1025
EOF
		
		mkdir -p "$INSTALL_DIR/sessions"
		echo -e "${CHECK} ${GREEN}php.ini created!${NC}"
	fi
	
	echo -e "${YELLOW}PHP Configuration File: $CONF_DIR/php.ini${NC}\n"
	
	echo -e "${BLUE}Current Settings:${NC}"
	cat "$CONF_DIR/php.ini" | grep -v "^;" | grep -v "^$" | head -20
	echo -e "\n...(truncated)\n"
	
	echo -e "${YELLOW}Options:${NC}"
	echo "1) Edit php.ini with nano"
	echo "2) Edit php.ini with vim"
	echo "3) View full php.ini"
	echo "4) Reset to defaults"
	echo "5) Back"
	echo
	read -p "Select option: " OPTION
	
	case $OPTION in
		1)
			nano "$CONF_DIR/php.ini" ;;
		2)
			vim "$CONF_DIR/php.ini" ;;
		3)
			less "$CONF_DIR/php.ini" ;;
		4)
			rm -f "$CONF_DIR/php.ini"
			echo -e "${CHECK} ${GREEN}php.ini reset. Will be recreated with defaults.${NC}"
			php_edit_config ;;
		*)
			return ;;
	esac
	
	echo -e "\n${YELLOW}Note: Restart PHP-FPM for changes to take effect.${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

php_logs() {
	echo -e "${BLUE}=== PHP Logs ===${NC}\n"
	
	echo -e "${YELLOW}Select log to view:${NC}"
	echo "1) PHP-FPM Log ($INSTALL_DIR/php-fpm.log)"
	echo "2) PHP Error Log ($INSTALL_DIR/php-error.log)"
	echo "3) Tail PHP-FPM Log (live)"
	echo "4) Clear all PHP logs"
	echo "5) Back"
	echo
	read -p "Select option: " OPTION
	
	case $OPTION in
		1)
			if [[ -f $INSTALL_DIR/php-fpm.log ]]; then
				less "$INSTALL_DIR/php-fpm.log"
			else
				echo -e "${YELLOW}No PHP-FPM log file found.${NC}"
				read -n 1 -s -p "Press any key to continue..."
			fi ;;
		2)
			if [[ -f $INSTALL_DIR/php-error.log ]]; then
				less "$INSTALL_DIR/php-error.log"
			else
				echo -e "${YELLOW}No PHP error log file found.${NC}"
				read -n 1 -s -p "Press any key to continue..."
			fi ;;
		3)
			echo -e "${YELLOW}Tailing PHP-FPM log (Ctrl+C to exit)...${NC}\n"
			tail -f "$INSTALL_DIR/php-fpm.log" 2>/dev/null || echo "Log file not found." ;;
		4)
			echo -e "${YELLOW}Clearing PHP logs...${NC}"
			> "$INSTALL_DIR/php-fpm.log" 2>/dev/null
			> "$INSTALL_DIR/php-error.log" 2>/dev/null
			echo -e "${CHECK} ${GREEN}PHP logs cleared!${NC}"
			read -n 1 -s -p "Press any key to continue..." ;;
		*)
			return ;;
	esac
}

php_clear_opcache() {
	if ! is_running "$CONF_DIR/php-fpm.conf"; then
		echo -e "${ERROR} ${RED}PHP-FPM is not running! Please start PHP first.${NC}"
		read -n 1 -s -p "Press any key to continue..."
		return 1
	fi
	
	echo -e "${YELLOW}Clearing OPcache...${NC}"
	
	cat > "$WWW_DIR/opcache_clear.php" <<'EOF'
<?php
if (function_exists('opcache_reset')) {
    opcache_reset();
    echo "OPcache cleared successfully!";
} else {
    echo "OPcache is not available.";
}
?>
EOF
	
	curl -s "http://localhost:8080/opcache_clear.php" 2>/dev/null || echo "Could not connect to server"
	echo
	
	rm -f "$WWW_DIR/opcache_clear.php"
	
	echo -e "${CHECK} ${GREEN}OPcache clear attempted!${NC}"
	read -n 1 -s -p "Press any key to continue..."
}

php_test() {
	echo -e "${YELLOW}Running PHP test...${NC}\n"
	
	nix-portable nix-shell -p $PHP_VERSION --run "
		echo '=== PHP Syntax Check ==='
		php -v
		echo
		echo '=== Testing PHP execution ==='
		php -r 'echo \"PHP is working! Current time: \" . date(\"Y-m-d H:i:s\") . \"\\n\";'
		echo
		echo '=== Checking common extensions ==='
		php -r '
			\$extensions = [\"pdo\", \"mysqli\", \"json\", \"mbstring\", \"curl\", \"openssl\", \"zip\", \"gd\"];
			foreach (\$extensions as \$ext) {
				\$status = extension_loaded(\$ext) ? \"OK\" : \"MISSING\";
				echo \"  \$status \$ext\\n\";
			}
		'
	" 2>/dev/null
	
	echo
	read -n 1 -s -p "Press any key to continue..."
}

start_apache(){
	if ! ensure_rewrite_support; then
		return 1
	fi
	if [[ ! -f "$CONF_DIR/httpd.conf" ]]; then
		echo -e "${ERROR} ${RED}Apache config not found: $CONF_DIR/httpd.conf${NC}"
		return 1
	fi
	nix-portable nix-shell -p apacheHttpd --run "
		httpd -f $CONF_DIR/httpd.conf &
	"
	if ! wait_until_running "$CONF_DIR/httpd.conf" 20 0.25; then
		echo -e "${ERROR} ${RED}Apache failed to start.${NC}"
		return 1
	fi
	clear
}

start_php(){
	if [[ ! -f "$CONF_DIR/php-fpm.conf" ]]; then
		echo -e "${ERROR} ${RED}PHP-FPM config not found: $CONF_DIR/php-fpm.conf${NC}"
		return 1
	fi
	nix-portable nix-shell -p $PHP_VERSION  --run "
		php-fpm -y $CONF_DIR/php-fpm.conf &
	"
	if ! wait_until_running "$CONF_DIR/php-fpm.conf" 20 0.25; then
		echo -e "${ERROR} ${RED}PHP-FPM failed to start.${NC}"
		return 1
	fi
	clear
}

stop_apache(){
	if is_running "$CONF_DIR/httpd.conf"; then
		pkill -f "$CONF_DIR/httpd.conf"
		if ! wait_until_stopped "$CONF_DIR/httpd.conf" 20 0.25; then
			echo -e "${ERROR} ${RED}Apache did not stop cleanly.${NC}"
			return 1
		fi
	fi
	clear
}

stop_php(){
	if is_running "$CONF_DIR/php-fpm.conf"; then
		pkill -f "$CONF_DIR/php-fpm.conf"
		if ! wait_until_stopped "$CONF_DIR/php-fpm.conf" 20 0.25; then
			echo -e "${ERROR} ${RED}PHP-FPM did not stop cleanly.${NC}"
			return 1
		fi
	fi
	clear
}

start_mysql(){
	config_mysql
	
	local FIRST_INIT=false
	
	if [[ ! -f $INSTALL_DIR/mysql/data/mysql/db.opt ]]; then
		echo -e "${YELLOW}Initializing MySQL database...${NC}"
		nix-portable nix-shell -p mysql --run "
			mysql_install_db --defaults-file=$INSTALL_DIR/mysql/my.cnf --datadir=$INSTALL_DIR/mysql/data --user=\$(whoami)
		" 2>/dev/null
		echo -e "${CHECK} ${GREEN}MySQL database initialized!${NC}"
		FIRST_INIT=true
	fi
	
	MYSQLD_LOG="$INSTALL_DIR/mysql/mysql.log"
	echo -e "${YELLOW}Starting MySQL...${NC}"
	nix-portable nix-shell -p mysql --run "
		mysqld_safe --defaults-file=$INSTALL_DIR/mysql/my.cnf &
	" > "$MYSQLD_LOG" 2>&1 &
	if ! wait_until_running "mysqld" 40 0.25; then
		echo -e "${ERROR} ${RED}MySQL failed to start.${NC}"
		return 1
	fi
	echo -e "${CHECK} ${GREEN}MySQL started!${NC}"
	
	if [[ "$FIRST_INIT" == true ]]; then
		local initial_root_password
		if ! initial_root_password="$(mysql_prompt_new_root_password)"; then
			echo -e "${ERROR} ${RED}MySQL initial password setup cancelled.${NC}"
			stop_mysql 2>/dev/null || true
			return 1
		fi
		if ! set_mysql_initial_password "$initial_root_password"; then
			echo -e "${ERROR} ${RED}Failed to set initial MySQL root password.${NC}"
			stop_mysql 2>/dev/null || true
			return 1
		fi
		mysql_save_root_password "$initial_root_password"
	fi
	clear
}

stop_mysql(){
	echo -e "${YELLOW}Stopping MySQL...${NC}"
	
	if is_running "mysqld"; then
		local shutdown_root_password=""
		shutdown_root_password="$(mysql_load_root_password 2>/dev/null || true)"
		if [[ -n "$shutdown_root_password" ]]; then
			local escaped_shutdown_password
			printf -v escaped_shutdown_password '%q' "$shutdown_root_password"
			nix-portable nix-shell -p mysql --run "
				MYSQL_PWD=$escaped_shutdown_password mysqladmin --socket=$INSTALL_DIR/mysql/mysql.sock -u root shutdown
			" 2>/dev/null || true
		else
			nix-portable nix-shell -p mysql --run "
				mysqladmin --socket=$INSTALL_DIR/mysql/mysql.sock shutdown
			" 2>/dev/null || true
		fi
		wait_until_stopped "mysqld" 20 0.25 || true
	fi
	
	if is_running "mysqld"; then
		echo -e "${YELLOW}Force stopping MySQL processes...${NC}"
		pkill -f "mysqld_safe" 2>/dev/null || true
		pkill -f "mysqld" 2>/dev/null || true
		if ! wait_until_stopped "mysqld" 20 0.25; then
			echo -e "${ERROR} ${RED}MySQL did not stop cleanly.${NC}"
			return 1
		fi
	fi
	
	if [[ -f $INSTALL_DIR/mysql/mysql.pid ]]; then
		rm -f "$INSTALL_DIR/mysql/mysql.pid"
	fi
	
	echo -e "${CHECK} ${GREEN}MySQL stopped!${NC}"
	clear
}

restart_apache(){
	stop_apache && sleep 1
	start_apache
}

restart_php(){
	stop_php && sleep 1
	start_php
}


restart_all() {
	restart_apache
	restart_php
	restart_mysql
	restart_mailhog
}

start_all(){
	if ! is_running "$CONF_DIR/httpd.conf"; then
		start_apache
	fi
	if ! is_running "$CONF_DIR/php-fpm.conf"; then
		start_php
	fi
	if ! is_running "mysqld"; then
		start_mysql
	fi
	if ! is_running "MailHog"; then
		start_mailhog
	fi
	clear
}

stop_all(){
	stop_apache
	stop_php
	stop_mysql
	stop_mailhog
	clear
}

restart(){
	restart_apache
	restart_php
	restart_mysql
	restart_mailhog
	clear
}

all_menu(){
	clear
	local ACTIONS
	while true; do
		remove_dblock
		printf "\n${BLUE}${ROCKET} ${TITLE} ${ROCKET}${NC}\n"

		ACTIONS=("Start" "Stop" "Restart" "Refresh")
		
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --highlight-line --height=10% --layout=reverse --prompt="All > ")
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"Start")
			 	start_all ;;
			"Stop")
			 	stop_all ;;
			"Restart")
				restart_all ;;
			"Refresh")
				refresh_menu ;;
		esac
	done
	clear
}

apache_menu(){
	local ACTIONS
	while true; do
		clear
		remove_dblock
		printf "\n${BLUE}${ROCKET} ${TITLE} ${ROCKET}${NC}\n"
		ACTIONS=($(if ! is_running "$CONF_DIR/httpd.conf"; then
			echo Start
		else
			echo Stop
		fi) "Restart" "Refresh")
		
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --highlight-line --height=10% --layout=reverse --prompt="Apache > ")
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"Start")
			 	start_apache ;;
			"Stop")
			 	stop_apache ;;
			"Restart")
				restart_apache ;;
			"Refresh")
				refresh_menu ;;
		esac
	done
	clear
}

php_menu(){
	clear
	local ACTIONS
	while true; do
		remove_dblock
		printf "\n${BLUE}${ROCKET} ${TITLE} - PHP ${ROCKET}${NC}\n"
		echo -e "${YELLOW}Current Version: ${GREEN}$PHP_VERSION${NC}\n"
		
		ACTIONS=($(if ! is_running "$CONF_DIR/php-fpm.conf"; then
			echo Start
		else
			echo Stop
		fi) "Restart" "Change Version" "PHP Info" "Extensions" "phpinfo()" "Configuration" "Logs" "Clear OPcache" "Test PHP" "Refresh")
		
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --highlight-line --height=18% --layout=reverse --prompt="PHP > ")
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"Start")
			 	start_php ;;
			"Stop")
			 	stop_php ;;
			"Restart")
				restart_php ;;
			"Change Version")
				select_php ;;
			"PHP Info")
				php_info ;;
			"Extensions")
				php_extensions ;;
			"phpinfo()")
				php_phpinfo ;;
			"Configuration")
				php_edit_config ;;
			"Logs")
				php_logs ;;
			"Clear OPcache")
				php_clear_opcache ;;
			"Test PHP")
				php_test ;;
			"Refresh")
				refresh_menu ;;
		esac
	done
	clear
}

restart_mysql() {
	clear
	stop_mysql
	start_mysql
}

mysql_menu() {
	clear
	local ACTIONS
	echo -e "\n${BLUE}${ROCKET} ${TITLE} ${ROCKET}${NC}"
	while true; do
		remove_dblock
		ACTIONS=("Start" "Stop" "Restart" "Change Password" "Reset Password" "Reset Data" "Config" "Refresh")
		
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --highlight-line --height=15% --layout=reverse --prompt="MySQL > ")
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"Start")
			 	start_mysql ;;
			"Stop")
			 	stop_mysql ;;
			"Restart")
				restart_mysql ;;
			"Change Password")
				mysql_change_password ;;
			"Reset Password")
				mysql_reset_password ;;
			"Reset Data")
				mysql_reset_data ;;
			"Config")
				config_mysql ;;
			"Refresh")
				refresh_menu ;;
		esac
	done
	clear
}

mail_menu() {
	clear
	local ACTIONS
	echo -e "\n${BLUE}${ROCKET} ${TITLE} - Mail Server ${ROCKET}${NC}"
	echo -e "${YELLOW}MailHog - Email Testing Tool${NC}"
	echo -e "${BLUE}SMTP: localhost:1025 | Web UI: http://localhost:8025${NC}\n"
	while true; do
		remove_dblock
		ACTIONS=($(if ! is_running "MailHog"; then
			echo Start
		else
			echo Stop
		fi) "Restart" "Open Web UI" "Send Test Email" "Users: List" "Users: Create" "Users: Update" "Users: Delete" "Users: View" "Configure PHP" "Config" "Refresh")
		
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | fzf --border --highlight-line --height=15% --layout=reverse --prompt="Mail > ")
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"Start")
			 	start_mailhog ;;
			"Stop")
			 	stop_mailhog ;;
			"Restart")
				restart_mailhog ;;
			"Open Web UI")
				open_mailhog_ui ;;
			"Send Test Email")
				test_email ;;
			"Users: List")
				mailhog_users_list ;;
			"Users: Create")
				mailhog_user_create ;;
			"Users: Update")
				mailhog_user_update ;;
			"Users: Delete")
				mailhog_user_delete ;;
			"Users: View")
				mailhog_user_view ;;
			"Configure PHP")
				config_php_mail ;;
			"Config")
				config_mailhog ;;
			"Refresh")
				refresh_menu ;;
		esac
	done
	clear
}

refresh_menu() {
	clear
}

main_menu(){
	clear
	local ACTIONS
	ACTIONS=("All" "Apache" "PHP" "MySQL" "Mail" "Refresh" "Settings" "About" "Exit")
	while true; do
		remove_dblock
		printf "\n${BLUE}${ROCKET} ${TITLE} ${ROCKET}${NC}\n"
		local SELECTED_ACTION=$(printf "%s\n" "${ACTIONS[@]}" | VERBOSE_MODE="$VERBOSE_MODE" fzf --border --highlight-line --height=12% --layout=reverse \
		--preview-window=80%:wrap --preview='
		SELECTED={}
		if [[ $SELECTED == "All" ]]; then
			echo -e "Apache status: \t'$(if ! pgrep -af "$CONF_DIR/httpd.conf" > /dev/null; then 
				echo INACTIVE
			else
				echo ACTIVE
			fi)'"
			echo -e "PHP status: \t'$(if ! pgrep -af "$CONF_DIR/php-fpm.conf" > /dev/null; then 
				echo INACTIVE
			else
				echo ACTIVE
			fi)'"
			echo -e "MySQL status: \t'$(if ! pgrep -af "mysqld" > /dev/null; then 
				echo INACTIVE
			else
				echo ACTIVE
			fi)'"
			echo -e "Mail status: \t'$(if ! pgrep -af "MailHog" > /dev/null; then 
				echo INACTIVE
			else
				echo ACTIVE
			fi)'"
		fi
		if [[ $SELECTED == "Apache" ]]; then
			echo "Status: '$(if ! pgrep -af "$CONF_DIR/httpd.conf" > /dev/null; then 
				echo INACTIVE
			else
				echo ACTIVE
			fi)'"
		  nix-portable nix-shell -p apacheHttpd --run "httpd -v" 2>/dev/null
		  if [[ ${VERBOSE_MODE:-0} == "1" ]]; then
		  	echo -e "\n===Logs===\n"
		  	[[ -f '$INSTALL_DIR'/apache/logs/error_log ]] && cat '$INSTALL_DIR'/apache/logs/error_log
		  fi
		fi
		if [[ $SELECTED == "PHP" ]]; then
			echo "Status: '$(if ! pgrep -af "$CONF_DIR/php-fpm.conf" > /dev/null; then 
				echo INACTIVE
			else
				echo ACTIVE
			fi)'"
		  nix-portable nix-shell -p '$PHP_VERSION' --run "php -v" 2>/dev/null
		  if [[ ${VERBOSE_MODE:-0} == "1" ]]; then
		  	echo -e "\n===Logs===\n"
		  	[[ -f '$INSTALL_DIR'/php-fpm.log ]] && cat '$INSTALL_DIR'/php-fpm.log
		  fi
		fi
		if [[ $SELECTED == "MySQL" ]]; then
			echo "Status: '$(if ! pgrep -af "mysqld" > /dev/null; then 
				echo INACTIVE
			else
				echo ACTIVE
			fi)'"
		  nix-portable nix-shell -p mysql --run "mysql --version" 2>/dev/null
		  if [[ ${VERBOSE_MODE:-0} == "1" ]]; then
		  	echo -e "\n===Logs===\n"
		  	[[ -f '$INSTALL_DIR'/mysql/mysql.log ]] && cat '$INSTALL_DIR'/mysql/mysql.log
		  fi
		fi
		if [[ $SELECTED == "Mail" ]]; then
			echo "Status: '$(if ! pgrep -af "MailHog" > /dev/null; then 
				echo INACTIVE
			else
				echo ACTIVE
			fi)'"
			echo -e "\nMailHog - Email Testing Tool"
			echo -e "SMTP Server: localhost:1025"
			echo -e "Web UI: http://localhost:8025"
			if [[ ${VERBOSE_MODE:-0} == "1" ]]; then
				echo -e "\n===Logs===\n"
				[[ -f '$INSTALL_DIR'/mailhog/mailhog.log ]] && tail -20 '$INSTALL_DIR'/mailhog/mailhog.log
			fi
		fi
		')
		[[ -z $SELECTED_ACTION ]] && break
		case $SELECTED_ACTION in
			"All")
				all_menu ;;
			"Apache")
			 	apache_menu ;;
			"PHP")
			 	php_menu ;;
			"MySQL")
				mysql_menu ;;
			"Mail")
				mail_menu ;;
			"Refresh")
				refresh_menu ;;
			"Settings")
				settings_menu ;;
			"About")
				about ;;
			"Exit")
				bye ;;
		esac
	done
	clear
}

about() {
	clear
	local current_php_version="${PHP_VERSION:-not-set}"
	echo -e "${BLUE}${ROCKET} ${TITLE} ${ROCKET}${NC}"
	echo
	echo -e "${YELLOW}Authors:${NC} $AUTHORS"
	echo
	echo -e "${BLUE}Runtime Context${NC}"
	echo -e "Install Path: $INSTALL_DIR"
	echo -e "Web Root: $WWW_DIR"
	echo -e "Config Path: $CONF_DIR"
	echo -e "PHP Package: $current_php_version"
	echo
	echo -e "${BLUE}Service Status${NC}"
	echo -e "Apache: $(service_status_label "$CONF_DIR/httpd.conf")"
	echo -e "PHP-FPM: $(service_status_label "$CONF_DIR/php-fpm.conf")"
	echo -e "MySQL: $(service_status_label "mysqld")"
	echo -e "MailHog: $(service_status_label "MailHog")"
	echo
	echo -e "${BLUE}Tool Availability${NC}"
	echo -e "nix-portable: $(tool_status_label "nix-portable")"
	echo -e "fzf: $(tool_status_label "fzf")"
	echo -e "jq: $(tool_status_label "jq")"
	echo -e "curl: $(tool_status_label "curl")"
	echo -e "nc: $(tool_status_label "nc")"
	read -n 1 -s
	clear
}

bye() {
	echo -e "\nBye! ${SUCCESS} ${GREEN}Thank you for using ApacheNest!${NC}\n"
	exit 0
}

trap bye SIGINT

parse_cli_arguments "$@"
require_interactive_tty
configure_env
settings_load_runtime_values
if [[ ! -d $INSTALL_DIR ]]; then
	setup_apachenest || {
		echo -e "${ERROR} ${RED}ApacheNest setup failed.${NC}"
		exit 1
	}
	configure_env
	settings_load_runtime_values
fi
require_commands
if ! ensure_rewrite_support; then
	echo -e "${ERROR} ${RED}Failed to apply rewrite support.${NC}"
	exit 1
fi
remove_dblock
main_menu
